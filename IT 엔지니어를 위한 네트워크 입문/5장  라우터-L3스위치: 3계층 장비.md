# 5장 리우터/L3 스위치: 3계층 장비
라우터란?
> 3계층에서 동작하는 여러 네트워크 장비의 대표격, 경로를 지정해주는 장치
> 들어오는 패킷의 목적지 IP 주소를 확인하고 자신이 가진 경로 정보를 이용해 패킷을 최적의 경로로 포워딩
> 원격지 네트워크와 연결할 때 필수 네트워크 장비


## 5.1 라우터의 동작 방식과 역할
- 다양한 경로 정보를 수집해 최적의 경로를 라우팅 테이블에 저장한 후 패킷이 라우터에 들어오면 도착지 IP 주소와 라우팅 테이블을 비교해 최선의 경로로 포워딩 => 경로지정
- 앞서 배운 2계층 장비인 스위치는 자신이 가진 맥주소 테이블에 도착치 맥주소가 없으면 해당 로컬 네트워크에 해당 기기가 연결되어져 있음을 확신하기 때문에 플러딩(전체에 다 보냄)을 진행하지만 라우터는 도착지 IP가 라우팅 테이블에 없으면 그냥 버린다. => 브로드캐스트 컨트롤
- 라우터는 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거하고 새로운 2계층 해더를 만들어 낸다. => 프로토콜 변환

### 경로 지정
- 경로 정보를 모아 라우팅 테이블을 만들고 패킷이 라우터로 들어오면 패킷의 도착지 IP 주소를 확인해 경로를 지정하고 패킷을 포워딩한다.
- 경로 정보를 얻는 방법
  - 자연스럽게 인접 네트워크 정보를 얻는 방법
  - 관리자가 직접 경로 정보를 입력하는 방법
  - 라우터끼리 서로 경로 정보를 자동으로 교환하는 방법

### 브로드캐스트 컨트롤
- 스위치는 로컬 네트워크에 존재하는 2계층 장비이기 때문에 맥주소 테이블에 없는 도착지 맥주소가 들어오면 이를 스위치에 연결된 모든 기기에 플러딩을 보내도 비용이 많이 발생하지 않지만
- 라우터는 원격지로 패킷을 보내는 것이며 인터넷 연결은 대부분 지정된 대역폭만 빌려 사용하기 때문에 쓸모없는 통신이 네트워크를 차지하는 것을 최대한 막으려고 노력한다.
- 따라서 라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는다.

### 프로토콜 변환
- 라우터는 서로 다른 프로토콜로 구성된 네트워크를 연결한다.
- 현대 네트워크는 이더넷으로 수렴되지만 과거에는 LAN에서 사용하는 프로토콜과 WAN에서 사용하는 프로토콜이 다른 구분된 공간이었다.
- 라우터에 패킷이 들어오면 2계층까지의 헤더 정보를 벗겨내고 3계층 주소를 확인한 후 2계층 헤더 정보를 새로 만들어 외부로 내보낸다.

## 5.2 경로 지정 - 라우팅/스위칭
라우터가 패킷을 처리할 때 크게 두 가지 작업 수행
- 경로 정보를 얻어 경로 정보를 정리하는 역할
- 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할

특징 정리
- 라우터는 자신히 분명히 알고 있는 목적지 주소가 아니면 해당 패킷을 버리기 때문에 패킷이 들어오기 전에 경로 정보를 충분히 수집하고 있어야 한다.
- 하지만 인터넷에 존재하는 주소와 경로는 매우 많고 클래스 리스 네트워크로 전환된 후에 클래스에 있는 주소조차 서브네팅된 상태로 분산되어 존재한다.
- 그래서 적절하게 라우팅 테이블을 유지하는 것이 필요하다.
- 하지만 라우팅 테이블이에 있는 목적지 주소와 패킷의 목적지 주소가 정확하게 일치하지 않는 경우가 더 많다.
- 라우터는 서브넷 단위로 라우팅 정보를 습득하고 라우팅 정보를 최적화하기 위해서 서머리 작업을 통해 여러 개의 서브넷 정보를 뭉처 전달한다.
- 그렇기 때문에 정확하게 일치하지 않더라도 라우터가 가지고 있는 라우팅 테이블 정보 중 목적지에 가장 근접한 정보를 찾아 패킷을 포워딩한다.
  ![image](https://github.com/user-attachments/assets/e80f65d9-1c1c-4885-99dc-05749e25ffa4)

### 라우팅 동작과 라우팅 테이블
- 현대 인터넷에서는 단말부터 목적지까지 경로를 모두 책임지는 것이 아니라 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 라우터로 포워딩한다.
- 네트워크를 한 단계씩 뛰어넘는다는 의미로 이 기법을 홉-바이-홉 라우팅이라고 부르며 인접한 라우터를 넥스트 홉이라고 부른다.
- 라우터는 패킷이 목적지로 가는 전체 경로를 파악하지 않고 최적의 넥스트 홉을 선택해 보내준다.
- 넥스트 홉을 지정할 때 일반적으로 세 가지 방법을 사용
  ![image](https://github.com/user-attachments/assets/e2145b02-c7bb-4d55-9a42-967b87b7e35b)
  - 다음 라우터의 IP를 지정하는 방법
    - 일반적인 방법
  - 라우터의 나가는 인터페이스를 지정하는 방법
    - 특수한 경우
    - 넥스트 홈 라우터의 IP 주소를 모르더라도 MAC 주소 정보를 알아낼 수 있을 때만 사용할 수 있다.
    - WAN 구간 전용선에서 PPP나 HLDC와 같은 프로토콜을 사용해 상대방의 MAC 주소를 알 필요가 없거나 상대방 라우터에서 프록시 ARP가 동작해 정확한 IP 주소를 모르더라도 상대방의 MAC 주소를 알 수잇을 때와 같이 한정된 조건에서만 사용
      ```
      - PPP나 HDLC 환경:
        - 점대점 연결이므로 상대방이 항상 하나의 장치로 고정되어 MAC 주소 조회가 불필요.
      - 프록시 ARP 환경:
        - 라우터가 ARP 요청에 대해 대신 응답하기 때문에, 실제 IP 주소를 몰라도 MAC 주소를 얻을 수 있음.
        - 단, 상대방 라우터가 프록시 ARP를 지원해야 함.
      ```
  - 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정하는 방법

라우팅 테이블에 저장하는 데이터
- 목적지 주소
- 넥스트 홈 IP 주소, 나가는 로컬 인터페이스

PBR
- 라우터가 패킷을 어디로 포워딩할지 경로를 선택할 때는 출발지를 고려하지 않지만 이 출발지 주소를 이용해 라우팅 하도록 PBR(Policy-Based Routing) 기능을 사용할 수 있다.
- 하지만 목적지 주소만 수집하는 라우팅 테이블로는 이 기능을 활성화할 수 없고 라우터 정책과 관련된 별도의 설정이 필요하다.
- 이 기능은 관리가 어려워지고 문제가 발생하면 해결이 어려워 특별한 목적으로만 사용하자.

루프가 없는 3계층 TTL
- 3계층의 IP 헤더에는 TTL이라는 필드가 있다.
- 이 필드는 패킷이 네트워크에 살아있을 수 있는 시간이다. 앞서 2계층은 TTL이 없기 때문에 루프가 발생한다고 말했었다.
- 인터넷에 쓸모없는 패킷이 돌아다녀 대역폭을 낭비하는 것을 막기 위한 것인데
- 실제로 운영되던 사이트가 갑자기 없어지는 경우가 발생할 수 있고 대안 경로를 찾다가 순간적으로 마주보는 두 대의 라우터의 넥스트 홈이 각자 상태방으로 구성되어 패킷이 두 라우터 사이에서 계속 오갈 수도 있다.
- 따라서 3계층 헤더에는 TTL이 있으며 이 TTL은 라우터를 지날 때마다 1씩 줄어든다.
  ![image](https://github.com/user-attachments/assets/48f1bdd9-ddb4-447f-9013-191499b6ce87)

### 라우팅(라우터가 경로 정보를 얻는 방법)
라우터가 경로 정보를 얻는 방법 크게 3가지
- 다이렉트 커넥티드
- 스태틱 라우팅
- 다이나믹 라우팅

#### 다이렉트 커넥티드
- IP 주소를 입력할 때 사용된 IP 주소와 서브넷 마스크로 해당 IP 주소가 속한 네트워크 주소 정보를 알 수 있다.
- 라우터나 PC에서는 이 정보로 해당 네트워크에 대한 라우팅 테이블을 자동으로 만든다.
- 이 경로 정보를 다이렉트 커넥티드라고 부른다.
  ```
  결국 중간 어떠한 장비가 끼어들지 않고 동일 네트워크에 속학 라우터끼리의 통신이라고 볼 수 있다.
  나는 이 부분을 보면서 왜 같은 네트워크에 속했는데 라우터끼리의 통신이 필요한지 이해가 안되었다.
  그래서 왜 두 대 이상의 라우터가 같은 네트워크에 필요한 것인지 찾아보았다.
  - 같은 네트워크에서 라우터 2대를 쓰는 이유는 주로 다중 게이트웨이 제공, 백업 라우터 설정, 또는 네트워크 실험과 같은 특수한 경우입니다.
  - 같은 네트워크에서 장치 간 통신은 스위치나 허브를 통해 이루어지며, 라우터는 관여하지 않는 것이 일반적입니다.
  - 같은 네트워크에서도 라우터를 거치는 경우는 서브넷 설정 오류, 기본 게이트웨이 강제 설정, 또는 네트워크 분리 목적이 있을 때 발생합니다.
  ```
- 해당 정보는 강제로 지울 수 없다. 해당 네트워크 인터페이스가 비활성되어야만 자동으로 사라진다.
  ![image](https://github.com/user-attachments/assets/f2cc1aa6-4a84-49de-916f-4eb6ee8ddd49)

#### 스태틱 라우팅
- 관리자가 목적지 네트워크와 넥스트 홈을 라우터에 직접 지정해 경로 정보를 입력하는 것
- 스태틱 라우팅은 다이렉트 커넥티드처럼 연결된 인터페이스 정보가 삭제되거나 비활성화되면 연관된 스태틱 라우팅 정보가 자동 삭제된다.
- 다만 물리 인터페이스가 아닌 논리 인터페이스는 물리 인터페이스가 비활성화되더라도 함께 비활성화되지 않는 경우도 있어 라우팅 테이블에서 사라지지 않을 수도 잇다.

#### 다이나믹 라우팅
- 스태틱 라우팅은 변화가 적거나 크기가 작은 네트워크에서는 손쉽게 관리할 수 있지만 아닌 경우에는 라우터 너머의 상태 정보를 파악할 수 없어 라우터 사이의 회선이나 장애가 발생했을 때 장애 상황을 파악하고 대체 경로로 보낼 수 없다.
- 다이나믹 라우팅은 스태틱 라우팅의 이런 단점을 보완한다.
- 라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습한다.
- 주기적으로 또는 상태 정보가 변경될 때 라우터끼리 경로 정보를 교환하므로 회선이나 라우터 자체에 장애가 발생하면 이 상황을 인지해 대체 경로로 패킷을 포워딩할 수 있다.
- 관리자의 개입 없이 라우터끼리의 정보 교환만으로 장래를 인지하고 트래픽을 우회할 수 있으므로 대부분의 네트워크에서 다이나믹 라우팅이 사용된다. (하트비트와 같은 거 같다)
- 다이나믹 라우팅에서는 자신이 광고할 네트워크를 선언해주어야 한다.
  ![image](https://github.com/user-attachments/assets/9e7b55f6-8bde-495f-bcb0-aae80900d451)


### 스위칭(라우터가 경로를 지정하는 방법)
> 패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 라우터 외부로 포워딩 하는 작업 = 스위칭

- 정확히 일치하지 않는 경우는 가장 가깝게 매치되는 경로 정보를 찾느다.
- 이때 롱기스트 프리픽스 매치 기법을 이용해 갖고 잇는 경로 정보 중 가장 가까운 경로를 선택한다.
