# 6장 로드밸런서-방화벽: 4계층 장비(세션 장비)
- 앞 서 배웠던 클래스 기반의 주소 체계에서 IP 부족으로 인해 클래스 리스와 공인과 사설 IP의 개념이 등장하였다.
- 이와 함께 NAT 기술, 보안용 방화벽과 프록시와 같은 장비들이 등장하면서 4계층 이상에서 동작하는 네트워크 장비가 많아졌다고 한다.
- 이런 장비의 특징은 포트번호, 시퀀스 번호, ACK 번호에 대해 이해해야 한다.
- 2,3 계층에서 고려하지 않았던 통신의 방향성, 순서와 같은 통신 전반에 대한 관리가 필요하다. -> 세션 테이블

- 이번 장에서는 4계층 장비의 특징과 종류, 4계층 장비의 구성 시 유의해야 할 점, 4계층 이상의 애플리케이션 프로토콜을 다루는 확장 장비인 ADC을 다룬다.

## 6.1 4계층 장비의 특징
- 4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이를 기반으로 동작
- 세션 테이블과 그 안에 저장되는 세션 정보가 중요하기 때문에 4계층 장비를 세션장비라고도 부른다.
- 세션 장비를 추가할 때 최우선적으로 고려할 요소
  - 세션 테이블
    - 세션 장비를 세션 테이블 기반으로 운영
    - 세션 정보를 저장, 확인하는 전반에 대한 이해 필요
    - 세션 정보가 세션 테이블에 남아있는 라이프타임 존재 -> 따라서 이 부분 고려하기
## 6.2 로드 밸런서 
- 서버나 장비의 부하를 분산하기 위해 사용하는 장비
- 가장 많이 쓰이는 분야는 웹 서버의 부하 분산
- 작은 시스템을 여러 대 운영하는 스케일 아웃에서 사용자는 서버 배치와 상관 없이 하나의 서비스로 보여야 한다. 로드 밸런서가 서비스에 사용되는 대표 IP 주소를 가지게 되면서 사용자는 하나의 서비스처럼 보이게 된다.
- 그 밑에 시스템이 늘어나면서 로드 밸런서가 각 시스템의 실제 IP로 변경해서 요청을 보낸다.
- 로드밸러서가 동작하는 계층에 따라 4계층과 7계층으로 나뉜다.
  - L4 로드 밸런싱
    - 일반적인 동작 방식
    - TCP, UDP 정보를 기반으로 로드 밸런싱을 수행
    - 최근 로드 밸런서는 L4와 L7의 기능을 모두 지원
  - L7 로드 밸런싱
    - HTTP, FTP, SMTO와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다. 이런 장비를 ADC라고 부르며 프록시 역할을 수행한다.
    - 스퀴드나 Nginx에서 수행하는 리버스 르폭시와 유사하다.
  ### 6.2.1 L4 스위치
  - 4계층에서 동작하는 로드밸러서 기능이 있는 스위치
  - 내부 동작은 L4이지만 외형은 스위치와 같이 여러 개의 포트로 구성
  - 부하분산, 성능 최적화, 리다이렉션 기능 제공
  - 가성 서버, 가상 IP, 리얼 서버, 리얼 IP 설정
  - 가상 서버는 사용자가 바라 보는 실제 서비스이고 가상 IP는 사용자가 접근해야 하는 실제 IP / 리얼 서버는 실제 서비스를 수행하는 서버, 리얼 IP는 실제 서버의 IP
  - L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 한다.
  ### 6.2.2 ADC(Application Delivery Controller)
  - 애플리케이션 계층에서 동작하는 로드 밸런서
  - 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로 다양한 부하 분산, 정보 수정, 정보 필터링이 가능하다.
  - 따라서 섬세한 작업을 위해 프록시로 동작한다.
  - 대부분의 ADC는 4계츠의 기능도 함께 제공
  - 페일 오버(장애극복), 리다이렉션도 함께 수행, 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변호나 등이 가능, 프로토콜 최적화 기능도 제공
  ### 6.2.3 L4 스위치 vs ADC
  L4 스위치
  - TCP와 UDP 정보를 기반으로 부하 분산
