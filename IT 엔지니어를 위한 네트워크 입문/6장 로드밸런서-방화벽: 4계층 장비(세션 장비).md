# 6장 로드밸런서-방화벽: 4계층 장비(세션 장비)
- 앞 서 배웠던 클래스 기반의 주소 체계에서 IP 부족으로 인해 클래스 리스와 공인과 사설 IP의 개념이 등장하였다.
- 이와 함께 NAT 기술, 보안용 방화벽과 프록시와 같은 장비들이 등장하면서 4계층 이상에서 동작하는 네트워크 장비가 많아졌다고 한다.
- 이런 장비의 특징은 포트번호, 시퀀스 번호, ACK 번호에 대해 이해해야 한다.
- 2,3 계층에서 고려하지 않았던 통신의 방향성, 순서와 같은 통신 전반에 대한 관리가 필요하다. -> 세션 테이블

- 이번 장에서는 4계층 장비의 특징과 종류, 4계층 장비의 구성 시 유의해야 할 점, 4계층 이상의 애플리케이션 프로토콜을 다루는 확장 장비인 ADC을 다룬다.

## 6.1 4계층 장비의 특징
- 4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이를 기반으로 동작
- 세션 테이블과 그 안에 저장되는 세션 정보가 중요하기 때문에 4계층 장비를 세션장비라고도 부른다.
- 세션 장비를 추가할 때 최우선적으로 고려할 요소
  - 세션 테이블
    - 세션 장비를 세션 테이블 기반으로 운영
    - 세션 정보를 저장, 확인하는 전반에 대한 이해 필요
    - 세션 정보가 세션 테이블에 남아있는 라이프타임 존재 -> 따라서 이 부분 고려하기
## 6.2 로드 밸런서 
- 서버나 장비의 부하를 분산하기 위해 사용하는 장비
- 가장 많이 쓰이는 분야는 웹 서버의 부하 분산
- 작은 시스템을 여러 대 운영하는 스케일 아웃에서 사용자는 서버 배치와 상관 없이 하나의 서비스로 보여야 한다. 로드 밸런서가 서비스에 사용되는 대표 IP 주소를 가지게 되면서 사용자는 하나의 서비스처럼 보이게 된다.
- 그 밑에 시스템이 늘어나면서 로드 밸런서가 각 시스템의 실제 IP로 변경해서 요청을 보낸다.
- 로드밸러서가 동작하는 계층에 따라 4계층과 7계층으로 나뉜다.
  - L4 로드 밸런싱
    - 일반적인 동작 방식
    - TCP, UDP 정보를 기반으로 로드 밸런싱을 수행
    - 최근 로드 밸런서는 L4와 L7의 기능을 모두 지원
  - L7 로드 밸런싱
    - HTTP, FTP, SMTO와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다. 이런 장비를 ADC라고 부르며 프록시 역할을 수행한다.
    - 스퀴드나 Nginx에서 수행하는 리버스 르폭시와 유사하다.
### 6.2.1 L4 스위치
- 4계층에서 동작하는 로드밸러서 기능이 있는 스위치
- 내부 동작은 L4이지만 외형은 스위치와 같이 여러 개의 포트로 구성
- 부하분산, 성능 최적화, 리다이렉션 기능 제공
- 가성 서버, 가상 IP, 리얼 서버, 리얼 IP 설정
- 가상 서버는 사용자가 바라 보는 실제 서비스이고 가상 IP는 사용자가 접근해야 하는 실제 IP / 리얼 서버는 실제 서비스를 수행하는 서버, 리얼 IP는 실제 서버의 IP
- L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 한다.
### 6.2.2 ADC(Application Delivery Controller)
- 애플리케이션 계층에서 동작하는 로드 밸런서
- 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로 다양한 부하 분산, 정보 수정, 정보 필터링이 가능하다.
- 따라서 섬세한 작업을 위해 프록시로 동작한다.
- 대부분의 ADC는 4계츠의 기능도 함께 제공
- 페일 오버(장애극복), 리다이렉션도 함께 수행, 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변호나 등이 가능, 프로토콜 최적화 기능도 제공
### 6.2.3 L4 스위치 vs ADC
L4 스위치
- TCP와 UDP 정보를 기반으로 부하 분산
- TCP 레벨의 간단한 DOS공격 방어
- TCP 세션 재사용
ADC
- 애플리케이션이 프로토콜 이해, 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화를 제공 -> L4 스위치보다 더 다양한 기능 제공
- 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행 -> 이 중 하나가 정적 콘텐츠 캐싱
- 웹 서버는 콘텐츠 압축 기능이 있지만 ADC에서 이 역할을 수행해 웹 서버의 부하를 줄일 수있다.
![image](https://github.com/user-attachments/assets/1f48c41a-f1e4-4cc5-828f-d5b99bec897d)
- ADC에서는 SSL의 엔드 포인트로 동작해 클라이언트에서 ADC의 구간을 SSL로 처리, ADC와 웹 서버 사이를 일반 HTTP를 이용해 통신한다. 
- Nginx는 웹서버로 알고 있는데 ADC의 기능도 수행하고 있어 이 부분을 더 자세히 찾아봤다. 기본적으로 웹 서버(Web Server)이지만, ADC(Application Delivery Controller) 역할도 할 수 있다고 한다.

### 6.3 방화벽
- 네트워크 중간에 위채해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비
- 네트워크 3,4계층에서 동작하고 세션을 인지, 관리하는 SPI 엔진을 기반으로 동작하는 장비를 방화벽이라고 부른다.
- 이걸 보면서 갑자기 AWS 보안그룹이 방화벽인지 궁금해서 찾아봤다.
  ![image](https://github.com/user-attachments/assets/0fb93c19-6ed7-4cc1-92dc-e92ec5bf4b44)
- 방화벽은 NAT 동작 방식과 유사하게 세션 정보를 장비 내부에 저장
  ![image](https://github.com/user-attachments/assets/c244a64c-657b-4777-bcf9-4015cda5c5fd)
- 패킷이 외부로 나갈 때 세션 정보를 저장, 들어오거나 나갈 때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려낸다.
- 기본 정책 : 외부로 나가는 모든 패킷을 허용, 내부로 들어오는 모든 패킷 차단
### 6.4 4계층 장비를 통과할 때의 유의점(세션관리)
- 세션 테이블 정보를 이용해 패킷을 변경하거나 애플리케이션 성능 최적화하고 보안 강화하기 위해 패킷을 포워드하거나 드롭 
- 이를 위해서 애플리케이셔과 세션 장비 간 세션 정보를 동일하게 유지하거나 애플리케이션을 제작할 때 네트워크 중간에 있는 세션 장비를 고려해 여러 기능 추가해주어야 한다. -> 특히 세션 시간과 서비스 방향성을 고려해 비대칭 경로를 피해야 한다.
#### 6.4.1 세션 테이블 유지, 세션 정보 동기화
- 세션 테이블에 저장되는 세션 정보는 만료 시간을 가지고 있다. 왜냐하면 메모리로 관리되기 때문이다. 악의적인 사용자가 과도한 세션을 발생 시켜 세션 테이블을 가득 채운다면 다른 사용자의 요청을 방해할 수 있다 이에 따라 세션 정보 만료시간을 짧게 유지할 수도 있다.
- 만약에 내가 어플리케이션을 만들었고 세션 정보를 오랫동안 유지시키고자 한다고 하자. 그런데 세션 정보의 만료시간이 애플리케이션의 세션 타임아웃값보다 짧다면 요청은 차단될 수 있다. 특히나 이 요청이 SYN이 아닌 ACK라면 그렇다.

위 문제으 해결방안을 운영자와 개발자 입장에서 접근해보자
##### 6.4.1.1 세션 장비 운영자 입장
세션 만료 시간 증가
- 대부분의 세션 장비는 포트번호나 IP 주소마다 별도의 세션 만료 시간을 설정할 수 있다 따라서 메모리 고갈 문제를 예방할 수 있다.
- 하지만 세션 운영자가 정확한 정보를 얻어 설정할 수 있도록 개발자에게 전달해줘야 한다.

세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)
- 세션 테이블에 정보가 없는 ACK이 들어오면 방화벽은 패킷을 차단하지만 방화벽 옵션을 조절해서 정보가 없는 ACK 패킷이 들어오면 세션을 새로 만들고 통과
- 하지만 전체적인 보안이 취약해짐
- 비추천

세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
- TCP의 RST 플래그를 1로 세팅해 양 종단 장비에 전송하면 양 종단 장비에서는 세션이 비정상 종료되었다고 판단해서 해당 세션을 끊는다.
- 애플리케이션에서 통신이 필요하면 새로운 세션을 맺어 통신

##### 6.4.1.2 개발자 입장
애플리케이션에서 주기적인 패킷 발생 기능 추가
- 통신이 없더라도 일정 시가마다 양 단말 애플리케이션의 세션 상태 정보를 체크하는 더미 패킷을 보내는 기능을 추가하면 패킷이 주기적으로 발생해 중간 방화벽에서 세션 타임아웃이 발생하기 전에 세션을 유지
- 하지만 패킷을 주기적으로 보내는 기능만 구현되더라도 방화멱 세션 만료로 인한 문제는 쉽게 해결할 수 없다.

#### 6.4.2 비대칭 경로 문제

