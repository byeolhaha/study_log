# 7.1 NAT/PAT
![image](https://github.com/user-attachments/assets/77d5435e-813b-43c6-846c-97e5462b85bb)# 7.1 NAT/PAT
- NAT(Network Address Translation, 네크워크 주소 변환)는 이름 그대로 네트워크 주소를 변환하는 기술
- 하나의 네으워크 주소에 대한 다른 하나의 네트워크 주소로 변환하는 1:1 변환이 기본
- 하지만 IP 주소 고갈의 문제를 해결하기 위해 여러 개의 IP를 하나의 IP로 변환하는 기술도 NAT 기술 중 하나이다. 실제로 공식 명칭은 NAPT(Network Address Port Translation)이며 실무에서는 PAT라는 용어로 더 많이 사용된다.
- 사설 IP를 공인 IP로, 공인 IP에서 사설 IP로, 사설 IP에서 다른 사설 IP로 변환, 혹은 IPv4를 IPv6로 변환하는 기술도 포함
## 7.1.1 NAT/PAT의 용도와 필요성
- IPv4 주소 고갈 문제의 솔루션을 NAT가 사용
  - 주소 고갈 문제를 해결하기 위한 3가지 솔루션
    - 단기 : 서브네팅
    - 중기 : NAT와 사설 IP 체계
    - 장기 : IPv6 전환
  - 여기 중에서 중기 계획인 주소를 고갈하지 않는 것에 큰 기여, 외부에 공개할 필요한 없는 일반 사용자의 PC나 기타 종단 장비에 대해서는 사설 IP를 사용해 꼭 필요한 곳에서만 효율적으로 IP를 사용할 수 있게 되었다.
- 보안 강화
  - IP주소는 네트워크에서 유일해야 하고 이 정보가 식별자로 사용되어 외부와 통신
  - 외부와 통신할 때 내부 IP를 다른 IP로 변환해 통신하면 외부 사내 IP 주소 체계를 숨길 수 있다.
  - NAT는 주소 변환 후 역변환이 정상적으로 다시 수행되어야만 통신이 가능, 이 성질을 이용해 복잡한 룰 설정 없이 방향성 통제 가능
  - 내부에서 외부로 나가는 방향 통신 허용하지만 외부에서 시작해서 내부로 들어오는 통신은 방어할 수 있다.
- IP 주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해준다.
  - IP 네트워크에서 서로 통신하려면 서로를 식별할 수 있는 고유한 IP를 가져야 하지만 서로 다른 회사의 사설 IP는 중복해서 가질 수 있다 이 이유는 NAT로 인해서
    통신할 때 서로의 고유한 공인 IP로 통신할 수 있도록 바꿔주기 때문이다.
  - 하지만 대외계 즉 카드사나 은행 간 연결은 별도의 네트워크를 사용하는데 이 때는 더블 NAT 기술이 사용된다고 한다.
- 불필요한 설정을 줄일 수 있다.
  - 보통 통신사업자나 IDC로부터 IP를 할당받아 사용하는데 만약에 통신사업자나 IDC를 옮겨서 IP를 다시 할당받게 되는 경우가 발생한다고 가정하자
  - NAT기술이 없었다면 연결된 모든 PC나 기타 장비에 대한 IP 설정을 모두 바꿔야하지만 NAT기술을 사용한다면 NAT의 공인 IP만 바꾸면 된다.
- 단점
  - IP가 변환되면 장애가 발생했을 때 문제 해결이 어려움
  - 단말간 직접적인 연결성이 무너졌고 이로 인해 개발자들이 애플리케이션 제작을 할 때 NAT 환경을 고려해야 한다.
    
![image](https://github.com/user-attachments/assets/88cc5461-8b9f-455c-b792-2a05e9af2e10)
- 위 그림은 읽다가 AWS와 맞춰서 생각하다가는 큰 오해를 불러일으킬 수 있다는 생각해서 정리해보고자 가져와봤다.
  - 일단 AWS의 서브넷은 public과 private으로 나눌 수 있다 여기에는 어떤 인스턴스들이 존재할까?
    - public 서브넷
      - 외부와 통신할 수 있는 즉 aws의 인터넷 게이트웨이를 통해서 외부와 직접 통신이 가능한 인스턴스들이 존재한다.
      - 이 인스턴스들은 private IP와 public IP를 가지며 내부 인스턴스들과는 private IP로 통신하고 외부와의 통신에서는 public IP로 통신한다.
    - private 서브넷
      - 외부와 양방향 통신을 할 수 없으며 아웃바운드만 가능하고 이에 따라 인터넷 게이트 웨이가 아닌 NAT GATEWAY를 통해 공인 IP로 바뀌고 인터넷 게이트웨이를 통해서 외부와 통신한다.
      - 아웃 바운드만 가능하다. 그러면 인바운드 요청은 어떻게 들어오는가?  퍼블리 서브넷에 존재하는 인스턴스들을 통해서 들어온다.
      - 보통 이 곳에는 데이터베이스와 같은 외부와 양방향 통신이 아닌 보안적으로 중요한 서버들이 존재한다.
    - 그래서 일반적인 NAT의 개념과 AWS의 NAT 게이트웨이는 살짝 다른다. 더 좁은 개념이 AWS NAT 게이트웨이로 NAT 중에서 아웃바운드만 가능한 SNAT(아웃바운드)만 지원한다.
    - 방화벽을 배울 때는 보안그룹과 방화벽의 일반적인 개념을 구분해서 생각할 줄 알아야 한다고 생각했고 AWS의 어떤 기술과 네트워크 기술이 결합되어져 있는지 생각해봐야 한다는 생각이 들었다.
## 7.1.2 NAT 동작 방식
![image](https://github.com/user-attachments/assets/0bf32061-1bb4-4e19-ab53-a9ac0d9acb3d)
## 7.1.3 PAT 동작 방식
![image](https://github.com/user-attachments/assets/30ac2715-6c2c-4437-8dd6-0b1ad63ff827)
- PAT는 포트번호까지 이용하는 방법
- 이렇게 하면 하나의 공인 IP에 0부터 65535까지의 포트번호를 연결하므로 65536개의 사설 IP를 매핑할 수 있어 NAT 방법보다 공인 IP를 더 적게 사용할 수 있다.
- PAT는 방화벽의 세션 테이블과 비슷하게 동작하기 때문에 내부에서 외부로 나갈 때 테이블에 작성하고 응답이 오면 해당 테이블에 작성되어 있는지 확인한다. 따라서 뒤에 배울 SNAT에서만 적용이 가능하다.
- 만약에 동시 사용자 수가 65536개를 초과한다면 동시접속이 불가능해서 오류가 발생한다고 한다 그래서 공인 IP 풀을 사용한다고 한다.
## 7.1.4 SNAT과 DNAT
- NAT를 사용해 네트워크 주소를 변환할 때 어떤 IP를 변환하는지에 따라 두 가지로 구분
  - SNAT(Source NAT) : 출발지 주소를 변경하는 NAT
    - 사설에서 공인으로
    - 사설에서 다른 사설 IP로 -> 대외계
  - DNAT(Destination NAT) : 도착지 주소를 변경하는 NAT
    - 로드 밸런서에서 많이 사용 : VIP에서 실제 IP로
    - 하나의 서비스에 대해서 여러 개의 대외사를 사용하는 경우 -> NAT에 도착지에 대한 네트워크 대역대를 넣어줌 -> 그러면 대외사가 추가되어도 사내 서버는 알 필요가 없음
## 7.1.5 동적 NAT과 정적 NAT
- 동적 NAT
  - 출발지와 목적지가 모두 정의된 것이 아니라 다수의 IP 풀에서 정해지므로 최소한 출발지나 목적지 중 한 곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정
  - NAT가 필요한 IP 풀에서 어떤 IP로 매핑될 것인지 판단해 NAT를 수행하는 시저에 NAT 테이블 만들어서 관리
  - NAT 테이블은 설정된 시간 동안 유지되고 일정 시간 동안 통신이 없으면 다시 사라진다.
- 정적 NAT
  - 출발지와 목적지 매핑 관계가 특정 IP로 사전에 정의된 것이므로 1:1 NAT라고 부르기도 한다.

# 7.2 DNS
네트워크 프로토콜
- 실제로 데이터를 실어나르는 데이터 프로토콜
- 이 데이터 프로토콜이 잘 동작하도록 도와주는 컨트롤 프로토콜
  이 컨트롤 프로토콜을 통신에 직접 관여하지 않지만 처음 통신 관계를 맺거나 유지하는 데 큰 역할
  - TCP/IP 프로토콜 체계를 유지하기 위한 주요 컨트롤 프로토콜 : ARP, ICMP, DNS
## 7.2.1 DNS 소개
- 숫자로 구성된 IP 정보를 기억하기 어려워서 문자열로 구성된 도메인 주소를 인식하고 있다.
- 그래서 이 문자열 주소를 IP 주소로 변환하는 DNS 정보를 네트워크 설정 정보에 입력해야 한다.
- 사용자가 도메인 주소를 사용하여 서비스를 요청하면 네트워크 설정에 입력한 DNS로 해당 도메인에 대한 IP 주소 질의를 보내고 그 결괏값으로 요청한 도메인의 서비스 IP 주소를 받게 된다.
## 7.2.2 DNS 구조와 명명 규칙 
- 도메인 계층 구조
- 역트리 구조, 최상위 루트부터 top, second, third로 각 계층마다 .으로 구분되면 루트는 생략됨
![image](https://github.com/user-attachments/assets/f36640ec-e33e-4903-88a5-008798942703)
- 알파벳, 숫자, "-"만 사용할 수 있으며 대소문자 구분 없음
### 7.2.2.1 루트 도메인
- DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 직접 갖고 있거나 캐시에 저장된 정보를 이용해 응답
- 만약에 DNS 서버에 해당 도메인에 대한 정보가 없으면 루트 도메인을 관리하는 루트 DNS에 쿼리
- 루트 DNS는 전 세계에 13개가 있고 DNS 서버를 설치하면 루트 DNS의 IP 주소를 기록한 힌트 파일을 가지고 있어 루트 DNS 관련 정보를 별도로 설정할 필요가 없다
### 7.2.2.2 top-level Domain
IANA에서 구분한 6가지 유형으로 구분할 수 있다.
- Generic(gTLD)
  - 특별한 제약없이 일반적으로 사용되는 최상위 도메인, 세 그랒 이상으로 구성
  - com, edu, gov, int, mil, net, org
- country-code
  - 국가 최상위 도메인, ISO 3166 표준에 의해 규정된 구 글자의 국가 코드 사용
  - 일반적으로 Second Level TLD에는 gTLD에서 구분한 것처럼 사이트 용도에 따른 코드를 사용
    - co.kr, go.kr
  - gTLD 그대로 사용하는 경우도 있음, com.au, gov.au, com.tw
- sponsored
  - 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
  - 특정 민족공동체, 전문가 집단, 지리적 위치 등
  - .aero, .asia, .edu, .museum
- infrastructure
  - 운용상 중요한 인프라 식별자 공간을 지원하기 위해 전용으로 사용되는 최상위 도메인
  - .arpa : 인터넷 안정성을 유지하기 위해 새로운 모든 인프라 하위 도메인이 배치될 도메인 공간 역할
  - ![image](https://github.com/user-attachments/assets/af6f856d-559e-4a34-80cf-ca5941c4934e)
- generic-resticted
  - 특정 기준을 충족하는 사람이나 단체가 사용할 수 있는 최상위 도메인, .biz, .name, .pro
- test
  - IDN 개발 프로세스에서 테스트 목적으로 사용하는 최상위 도메인
## 7.2.3 DNS 동작 방식
  - 도메인을 IP 주소로 변환하려면 DNS 서버에 도메인 쿼리하는 과정을 거쳐야 한다.
  - 하지만 DNS 서버 없이 로컬에 도메인과 IP 주소를 직접 설정해 사용할 수 있는데 이를 관리하는 파일이 hosts 파일이다.
  - host 파일에는 도메인과 IP 주소를 설정하면 해당 도메인 리스트는 항상 DNS 캐시에 저장된다.
  - 도메인을 쿼리하면 DNS 서버에 쿼리를 하기 전에 로컬에 있는 DNS 캐시 정보를 먼저 확인
  - 동일한 도메인을 매번 질의하지 않고 캐시를 통해 성능을 향상
  - 해당 캐시 = 기존 DNS 조회를 통해 확인한 동적 DNS 캐시 + hosts 파일에 저장된 정적 DNS 캐시
  - 만약에 캐시에 없다면 DNS 서버로 쿼리를 수행하고 응답을 받으면 그 결과를 캐시에 먼저 저장
  - 

동작 방식
- 전 세계 도메인 정보를 DNS 서버 하나에 저장할 수 없다 따라서 분산된 데이터베이스로 서로 도와주도록 설계됨
![image](https://github.com/user-attachments/assets/3a2fd81b-02da-40e6-9f08-f82646a5326e)
1. 사용자 호스트는 'zigispace.net'이라는 도메인 주소의 IP 주소가 로컬 캐시에 저장되어 있는지 확인
2. 없다면 사용자 호스트에 설정된 DNS에 'zigispace.net'에 대해 쿼리
3. DNS 서버는 'zigispace.net'이 로컬 캐시와 자체에 설정되어 있는지 확인 없으면 해당 도메인을 찾기 위해 루트 NS에 .net에 대한 TLD 정보를 가진 도메인 주소를 쿼리한다.
4. 루트 DNS는 'zigispace.net'의 TLD인 .net을 관리하는 네임서버 정보를 DNS 서버에 응답
5. DNS는 TLD 네임 서버에 'zigispace.net'에 대한 정보를 다시 쿼리
6. TLD 네임 서버는 'zigispace.net'에 대한 정보를 다시 쿼리
7. TLD 네임 서버는 'zigispace.net'에 대한 정보를 가진 zig 네임 서버에 대한 정보를 DNS 응답
8. DNS는 zigi 네임 서버에 'zigispace.net'에 대한 정보를 쿼리
9. zigi 네임서버는 'zigispace.net'에 대한 정보를 DNS에 응답
10. DNS는 'zigispace.net'에 대한 정보를 로컬 캐시에 저장하고 사용자 호스트에 'zigispace.net'에 대한 정보를 응답
11. 사용자 호스트는 DNS로부터 받은 'zigispace.net'에 대한 IP 정보를 이용해서 사이트에 접속

## 7.2.4 마스터와 슬래이브
- DNS 서버는 마스터와 슬레이브 서버로 나눌 수 있음
- 마스터 서버가 우선순위가 높거나 여기에서만 읽기가 발생하거나 그러지 않음 단순히 존 파일을 직접 생성하는 것 뿐이다.
- 따라서 마스터와 슬레이브 둘 다 쿼리에 응답한다. 다만 슬레이브는 마스터에 작성된 존 파일을 복제해서 가지고 있으며 이를 영역 전송이라고 한다.
- 무제한 복제 등 문제가 발생할 수 있어 마스터에 복제가 가능한 슬레이브 서버 정보를 설정해 놓는 것이 좋다.
- 우리가 알고 있는 마스터 슬레이브와 조금 다른데 마스터에 장애가 발생하면 슬레이브가 active로 바뀌지 않는다. 슬레이브는 일정 시간이 지나면 같이 죽는다. 이 일정 시간을 만료 시간이라고 하며 이 사이에 슬레이브가 마스터 서버에서 존 정보를 받아오지 못하면 슬레이브의 존 정보는 사용할 수 없다.
- 따라서 만료 시간 안에 마스터 서버를 복구하거나 슬레이브 서버를 마스터로 전환해야 한다.
## 7.2.5 DNS 주요 레코드
- 도메인에는 다양한 내용을 매핑할 수 있는 레코드가 있다.
- A 레코드
  - 도메인 주소를 IP 주소로 변환
  - 한 개의 도메인 주소 : 한 개의 IP 주소 혹은 한 개의 도메인 주소 : 여러 개의 IP 주소 or 다수의 도메인 : 한 개의 IP 주소
- AAAA(IPv6) 레코드
  - 역할은 A레코드와 동일
- CNAME 레코드
![image](https://github.com/user-attachments/assets/c9415069-c0bb-4c7f-99d4-7c44a6366a0c)
  - 별칭 이름을 사용하게 해주는 레코드
  - 네임 서버가 CNAME 레코드에 대한 질의를 받으면 CNAME 레코드에 설정된 도메인 정보를 확인하고 그 도메인 정보를 내부적으로 다시 질의한 결과 IP 값을 응답한다.
- SOA(Start Of Authority) 레코드
  - 도메인 영역에 대한 권한을 나타내는 레코드
  - 현재 네임 서버가 이 도메인 영역에 대한 관리 주체임을 의미하므로 해당 도메인에 대해서 다른 네임 서버에 질의하지 않고 직접 응답
  - 필수 항목이며 필요한 속성값을 설정 = 도메인 동기화에 필요한 타이머나 TTL 값과 함께 도메인의 네임서버나 관리자 정보도 SOA 레코드에 설정
- NS(Name Servier) 레코드
  - 도메인에 대한 권한이 있는 네임 서버 정보를 설정하는 레코드
  - 권한이 있는 네임 서버 정보를 해당 도메인에 설정하는 역할 외에 하위 도메인에 대한 권한을 다른 네임 서버로 위힘하는 역할로도 많이 사용
- MX(Main eXchange) 레코드
  - 메일 서버를 구성할 때 사용되는 레코드
  - 해당 도메인을 메일 주소로 갖는 메일 서버를 MX레코드를 통해 선언
  - 우선순위에 따라 실패하면 다음 우선순위로 보냄
- PTR 레코드
  - A레코드와 반대로 IP 주소에 대한 질의를 도메인 주소로 응답
  - A레코드와 달리 하나의 IP 주소에 대해서 하나의 도메인 주소만을 가질 수 있다.
- TXT(TeXT) 레코드
  - 간단한 텍스르를 입력할 수 있는 레코드
  - 화이트 도메인을 위한 SPF 레코드
  - 공백 포함할 수 있고 대소문자를 구분
## 7.2.6 DNS에서 알아두면 좋은 내용
### 7.2.6.1 도메인 위임 (DNS Delegation)
- 도메인은 그 도메인에 대한 정보를 관리할 수 있는 네임 서버를 지정하지만 도메인 내의 모든 레코드를 그 네임 서버가 직접 관리하지 않고 일부 영역에 대해서는 다른 곳에서 레코드를 관리하도록 위임하기도 한다. = 도메인 위임
- 즉, 자신이 가진 도메인 관리 권한을 다른 곳으로 일부 위힘해 위임한 곳에서 세부 레코드를 관리
- CDN을 이용하거나 GSLB를 사용하는 것이 대표적인 경우
![image](https://github.com/user-attachments/assets/0db45776-526a-4eb7-b799-6b9894f7dbe6)
- zigispace.net을 관리하는 네임 서버는 A DNS 서버로 지정
- A DNS 서버에는 home.zigispace.net, a.home.zigispace.net, blog.zigispce.net, b.blog.zigispace.net에 대한 레코드 정보가 있다.
- 하위 도메인 post를 추가하고 이를 B GSLB에 관리하려고 한다면 A DNS 서버에서 post 라는 영역의 관리 권한을 B GSLB로 넘겨 줄 수 있다. 이 방식을 위임이라고 한다.
- 도메인 위임 기능을 쓰면 특정 영역을 다른 네임 서버에서 관리할 수 있는 권한을 위임하게 된다.

### 7.2.6.2 TTL (Time To Live)
- DNS에 질의해 응답받은 결괏값을 캐시에서 유지하는 시간
- 캐시를 많이 이용하면 DNS 재귀적 쿼리로 인한 응답 시간을 많이 줄일 수 있다.
- 하지만 도메인 정보가 변경되었는데 TTL이 길어 정보가 갱신되지 않는 문제가 발생한다.
### 7.2.6.3 화이트 도메인
- 정상적으로 발송하는 대량 이메일이 RBL 이력으로 간주되어 차단되는 것을 예방하기 위해 사전에 등록된 개인이나 사업자에 한해 국내 주요 포탈 사이트로의 이메일 전송을 보장해주는 제도
  - RBL은 Real-time Blackhole List의 약자로, 실시간 블랙리스트를 의미
- 현재 보유 중인 도메인을 화이트 도메인으로 등록하려면 KISA RBL 사이트에서 화이트 도메인으로 등록
- 이를 위해서 사전에 해당 도메인에 SPF 레코드가 설정되어 있어야 한다.
- SPF(Sender Policy Framework) 레코드를 통해 사전에 메일 서버 정보를 공개하면 수신 측 메일 서버에서 해당 도메인을 통해 발송된 메일이 실제 메일 서버에 등록된 정보와 일치하는지 확인
- 메일 정보와 도메인의 SPF 정보가 일치하지 않을 때는 비정상적인 메일 서버에서 전송된 것으로 간주해 스팸 처리
### 7.2.6.4 한글 도메인
- 영문 뿐만 아니라 한글 주소로 만들 수 있음
- http://한국인터넷진흥원.한국가 그 예시
- 사용자가 도메인을 한글로 등록하고 사용하기 위해서 DNS에서는 해당 한글을 퓨티코드로 변경하고 이 퓨니코드로 DNS에 도메인을 생성

# 7.3 GSLB
- DNS에서 동일한 레코드 이름으로 서로 다른 IP 주소를 동시에 설정할 수 있다.
- 이런 설정을 하면 도메인 질의에 따라 응답받는 IP 주소를 나누어 로드밸런싱할 수 있다. = DNS 로드밸런싱
- 하지만 DNS로만 로드밸런싱을 하면 죽은 서버에 대한 헬스체크가 불가능함
- GSLB(Global Server/Service Load Balancing)는 DNS의 이런 문제점을 해결해 도메인을 이용한 로드밸런싱을 구현
### 7.3.1 GSLB 동작 방식
![image](https://github.com/user-attachments/assets/13a54d05-84e4-44ea-b1c7-58c43309898c)
- 앞 서 배운 위임에 따라 DNS가 위임한 GSLB에 대한 정보를 응답한다.
- 그러면 LDNS가 다시 GSLB로 web.zigispace.net에 대해 질의
- GSLB는 web.zigispace.net에 대한 IP 주솟값 중 현재 설정된 분산 방식에 따라 서울 또는 부산 데이터 센터의 IP 주솟값을 DNS에 응답
### 7.3.2 GSLB 구성 방식
도메인 설정 방법
- 도메인 자체를 GSLB로 사용
  - 도메인 구입 시 도메인에 대한 권한을 갖는 네임서버를 GSLB로 설정
  - 헬스 체크 기능이 불필요한 경우뿐만 아니라 모든 레코드에 대한 질의가 GSLB를 통해 이루지므로 GSLB에 부하를 준다.
- 도메인 내의 특정 레코드만 GSLB를 사용
  - GSLB로 처리를 이관하는 방법
    - 별칭 사용 CNAME 레코드 사용
      - DNS 서버에 CNAME 레코드로 CDN과 같은 외부 GSLB를 지정하면 CNAME의 레코드 값으로 등록된 FQDN을 GSLB로 재질의해 서버를 찾아가게된다.
      - ![image](https://github.com/user-attachments/assets/20978ee6-ede0-480a-a206-9416bcab7975)
      - CDN처럼 외부 사업자가 있거나 GSLB를 사용해야 하는 도메인이 많은 경우 별도의 GSLB를 운영하기 위해 사용
    - 위임 사용 NS 레코드 사용
      - ![image](https://github.com/user-attachments/assets/bffe180b-6d22-4eee-8832-21e43a8ddf52)
      - 같은 도메인으로 GSLB를 운영하면서 계층적으로 GSLB를 이용한 FQDN을 관리할 때 사용
## 7.3.3 GSLB 분산 방식
GSLB를 이용해 서비스를 분산하면 다음과 같은 주요 목적을 달성할 수 있다.
- 서비스 제공의 가능 여부를 체크해 트래픽 분산
- 지리적으로 멀리 떨어진 다른 데이터 센터에 트래픽 분산
- 지역적으로 가까운 서비스에 접속해 더 빠른 서비스 제공이 가능하도록 분산
서비스 헬스 체크를 통해 서비스를 안정적으로 제공하는 것 외에 서로 다른 사이트로 서비스를 분산시키는 것이 GSLB의 중요한 역할이다 이를 위해 GSLB는 로드 밸런서의 분산 방식과 동일하게 라운드 로빈이나 최소 접속, 해싱 방식 외에 추가적인 분산 방식을 제공한다.

GSLB 장비를 생산하는 벤더와 모델에 따라 조금씩 다르지만 대부분 다음 두가지 헬스 체크 모니터링 요소 제공
- 서비스 응답 시간/지연
  - 응답이 얼마나 빠른지 또는 지연이 얼마나 없는지를 확인하고 이것을 이용해 서비스를 분산 처리
- IP에 대한 지리 정보
  - 서비스 제공이 가능한 각 사이트의 IP 주소에 대한 Geo 값을 확인해 가까운 사이트로 서비스 분산
  - 이는 사용자 기준이 아니라 사용자가 바라보는 Local DNS와 GSLB 간 값이므로 설정에 유의하자 만약에 Local DNS가 해외에 있다면 사용자의 서비스 접속 시간은 더 길어질 수 있다.

# 7.4 DHCP (Dynamic Host Configuration Protocol)
- 호스트가 네트워크와 통신하려면 물리적 네트워크 구성은 물론 IP 주소, 서브넷 마스크, 게이트웨이와 같은 네트워크 정보와 DNS 주소 설정이 필요
- 이런 네트워크 정보를 사용자가 직접 설정하는 정적 할당과 자동으로 할당하는 것을 동적 할당이라고 한다.
- IP를 동적으로 할당하는 데 사용되는 프로토콜이 바로 DHCP이다.
## 7.4.1 DHCP 프로토콜
- BOOTP(Bootstrap Protocol)라는 프로토콜 기반
- BOOTP와 유사하게 동작하지만 BOOTP에서 지원되지 않는 몇 가지 기능이 추가된 확장 프로토콜
- DHCP는 서버와 클라이언트로 동작하며 클라이언트의 서비스 포트는 68, 서버의 서비스 포트는 67
## 7.4.2 DHCP 동작 방식
![image](https://github.com/user-attachments/assets/d608a8be-12b9-4b65-8ba2-9db47d9842bc)
호스트가 IP를 자동으로 할당받는 과정
1. DHCP Discover
   DHCP 클라이언트는 DHCP 서버를 찾기 위해서 DHCP Discover 메시지를 브로드캐스르로 전송, 처음에는 해당 클라이언트는 IP 주소가 없어서 Src IP가 0.0.0.0이다.
   이 때 사용되는 포트는 출발지가 UDP 68번, 목적지는 UDP 67번이다. IP를 할당받는 과정이므로 패킷을 정상적으로 주고받을 수 없어 TCP가 아닌 UDP이다.
2. DHCP Offer
   DHCP Discober를 수신한 DHCP 서버는 클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, Lease Time(주소 임대 시간) 등의 정보를 포함한 DHCP 메시지를 클라이언트로 전송
3. DHCP Request
   DHCP 서버로부터 제안받은 IP 주소와 DHCP 서버 정보를 포함한 DHCP 요청 메시지를 브로드캐스트로 전송
 DHCP Offer에서 DHCP 서버의 IP 주소를 받아 유니캐스트로 보낼 수 있는데 브로드캐스트로 보내는 이유는 DHCP 서버 여러 대가 동작하는 환경을 위해서 브로드캐스트로 보낸다. 클라이언트 서버는 Offer 메시지를 운용 중인 여러 대의 DHCP 서버로부터 받는다. 따라서 Request 메시지를 보낼 때 브로드캐스트로 보내며 이 Request 메시지를 받은 DHCP 서바가 본인 보낸 Offer 메시지의 IP 주소와 Request 메시지에 있는 출발지 IP 주소를 비교하여 확인하고 같은 것에 ㄷ해서만 응답한다. 
4. DHCP Acknowledgement
   DHCP 클라이언트로부터 IP 주소를 사용하겠다는 요청을 받으면 DHCP 서버에 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DHCP Request 메시지를 정상적으로 수신했다는 응답을 전송한다.

- 위 과정은 신규 생성이며 다시 갱신하고자 할 때 즉 임대 시간의 50%가지 지나면 DHCP Request와 DHCP ACK만 이루어지며 브로드캐스트가 아닌 유니캐스트로 진행된다.
- 이 때 실패하면 임대 시간의 75%가 지난 시점에 다시 진행되며 이래도 실패하면 그냥 IP를 반납하고 신규 생성이 진행된다.

## 7.4.3 DHCP 서버 구성
DHCP 서버를 구성할 때 주로 설정하는 값
- IP 주소 풀 : 클라이언트에 할당할 IP 주소 범위
- 예외 IP 주소 풀 : 클라이언트에 할당할 IP 주소로 선언된 범위 중 예외적으로 할당하지 않을 대역
- 임대 시간 : 클라이언트에 할당할 IP 주소의 기본 임대 시간
- 서브넷 마스크 :  클라이언트에 할당할 IP 주소에 대한 서브넷 마스크 정보
- 게이트웨이 : 클라이언트에 할당할 게이트웨이 정보
- DNS : 클라이언트에 할당할 DNS 주소
## 7.4.4 DHCP 릴레이
- DHCP 서버에서 IP 주소를 할당받기 위해 DHCP 클라이언트와 DHCP 서버 간에 전송되는 패킷은 모두 브로드캐스트이다.
- 브로드캐스트는 동일 네트워크에서만 전송되므로 DHCP를 사용하려면 네트워크마다 DHCP 서버가 있어야 한다.
- 네트워크 영역이 여러 개인 환경에서 DHCP를 이용하려면 배치, 이중화와 관련된 다양한 사항을 고려해야 한다.
- 하지만 여러 네트워크를 가진 환경에서도 DHCP 릴레이 에이전트 기능을 사용하면 DHCP 서버 한 대로 여러 네트워크 대역에서 IP 풀을 관리할 수 있다.
- 브로드캐스트로 전달되는 DHCP 패킷을 동일 네트워크 대역의 DHCP 릴레이 에이전트가 수신하여 DHCP 서버로 갈 수 있도록 이것을 유니캐스트로 변환해주는 역할을 한다.
![image](https://github.com/user-attachments/assets/6e9bc32c-bd21-4631-8560-62a30bf4c21c)

