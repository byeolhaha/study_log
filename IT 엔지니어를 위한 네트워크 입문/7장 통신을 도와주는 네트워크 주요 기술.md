# 7.1 NAT/PAT
- NAT(Network Address Translation, 네크워크 주소 변환)는 이름 그대로 네트워크 주소를 변환하는 기술
- 하나의 네으워크 주소에 대한 다른 하나의 네트워크 주소로 변환하는 1:1 변환이 기본
- 하지만 IP 주소 고갈의 문제를 해결하기 위해 여러 개의 IP를 하나의 IP로 변환하는 기술도 NAT 기술 중 하나이다. 실제로 공식 명칭은 NAPT(Network Address Port Translation)이며 실무에서는 PAT라는 용어로 더 많이 사용된다.
- 사설 IP를 공인 IP로, 공인 IP에서 사설 IP로, 사설 IP에서 다른 사설 IP로 변환, 혹은 IPv4를 IPv6로 변환하는 기술도 포함
## 7.1.1 NAT/PAT의 용도와 필요성
- IPv4 주소 고갈 문제의 솔루션을 NAT가 사용
  - 주소 고갈 문제를 해결하기 위한 3가지 솔루션
    - 단기 : 서브네팅
    - 중기 : NAT와 사설 IP 체계
    - 장기 : IPv6 전환
  - 여기 중에서 중기 계획인 주소를 고갈하지 않는 것에 큰 기여, 외부에 공개할 필요한 없는 일반 사용자의 PC나 기타 종단 장비에 대해서는 사설 IP를 사용해 꼭 필요한 곳에서만 효율적으로 IP를 사용할 수 있게 되었다.
- 보안 강화
  - IP주소는 네트워크에서 유일해야 하고 이 정보가 식별자로 사용되어 외부와 통신
  - 외부와 통신할 때 내부 IP를 다른 IP로 변환해 통신하면 외부 사내 IP 주소 체계를 숨길 수 있다.
  - NAT는 주소 변환 후 역변환이 정상적으로 다시 수행되어야만 통신이 가능, 이 성질을 이용해 복잡한 룰 설정 없이 방향성 통제 가능
  - 내부에서 외부로 나가는 방향 통신 허용하지만 외부에서 시작해서 내부로 들어오는 통신은 방어할 수 있다.
- IP 주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해준다.
  - IP 네트워크에서 서로 통신하려면 서로를 식별할 수 있는 고유한 IP를 가져야 하지만 서로 다른 회사의 사설 IP는 중복해서 가질 수 있다 이 이유는 NAT로 인해서
    통신할 때 서로의 고유한 공인 IP로 통신할 수 있도록 바꿔주기 때문이다.
  - 하지만 대외계 즉 카드사나 은행 간 연결은 별도의 네트워크를 사용하는데 이 때는 더블 NAT 기술이 사용된다고 한다.
- 불필요한 설정을 줄일 수 있다.
  - 보통 통신사업자나 IDC로부터 IP를 할당받아 사용하는데 만약에 통신사업자나 IDC를 옮겨서 IP를 다시 할당받게 되는 경우가 발생한다고 가정하자
  - NAT기술이 없었다면 연결된 모든 PC나 기타 장비에 대한 IP 설정을 모두 바꿔야하지만 NAT기술을 사용한다면 NAT의 공인 IP만 바꾸면 된다.
- 단점
  - IP가 변환되면 장애가 발생했을 때 문제 해결이 어려움
  - 단말간 직접적인 연결성이 무너졌고 이로 인해 개발자들이 애플리케이션 제작을 할 때 NAT 환경을 고려해야 한다.
    
![image](https://github.com/user-attachments/assets/88cc5461-8b9f-455c-b792-2a05e9af2e10)
- 위 그림은 읽다가 AWS와 맞춰서 생각하다가는 큰 오해를 불러일으킬 수 있다는 생각해서 정리해보고자 가져와봤다.
  - 일단 AWS의 서브넷은 public과 private으로 나눌 수 있다 여기에는 어떤 인스턴스들이 존재할까?
    - public 서브넷
      - 외부와 통신할 수 있는 즉 aws의 인터넷 게이트웨이를 통해서 외부와 직접 통신이 가능한 인스턴스들이 존재한다.
      - 이 인스턴스들은 private IP와 public IP를 가지며 내부 인스턴스들과는 private IP로 통신하고 외부와의 통신에서는 public IP로 통신한다.
    - private 서브넷
      - 외부와 양방향 통신을 할 수 없으며 아웃바운드만 가능하고 이에 따라 인터넷 게이트 웨이가 아닌 NAT GATEWAY를 통해 공인 IP로 바뀌고 인터넷 게이트웨이를 통해서 외부와 통신한다.
      - 아웃 바운드만 가능하다. 그러면 인바운드 요청은 어떻게 들어오는가?  퍼블리 서브넷에 존재하는 인스턴스들을 통해서 들어온다.
      - 보통 이 곳에는 데이터베이스와 같은 외부와 양방향 통신이 아닌 보안적으로 중요한 서버들이 존재한다.
    - 그래서 일반적인 NAT의 개념과 AWS의 NAT 게이트웨이는 살짝 다른다. 더 좁은 개념이 AWS NAT 게이트웨이로 NAT 중에서 아웃바운드만 가능한 SNAT(아웃바운드)만 지원한다.
    - 방화벽을 배울 때는 보안그룹과 방화벽의 일반적인 개념을 구분해서 생각할 줄 알아야 한다고 생각했고 AWS의 어떤 기술과 네트워크 기술이 결합되어져 있는지 생각해봐야 한다는 생각이 들었다.
## 7.1.2 NAT 동작 방식
![image](https://github.com/user-attachments/assets/0bf32061-1bb4-4e19-ab53-a9ac0d9acb3d)
## 7.1.3 PAT 동작 방식
![image](https://github.com/user-attachments/assets/30ac2715-6c2c-4437-8dd6-0b1ad63ff827)
- PAT는 포트번호까지 이용하는 방법
- 이렇게 하면 하나의 공인 IP에 0부터 65535까지의 포트번호를 연결하므로 65536개의 사설 IP를 매핑할 수 있어 NAT 방법보다 공인 IP를 더 적게 사용할 수 있다.
- PAT는 방화벽의 세션 테이블과 비슷하게 동작하기 때문에 내부에서 외부로 나갈 때 테이블에 작성하고 응답이 오면 해당 테이블에 작성되어 있는지 확인한다. 따라서 뒤에 배울 SNAT에서만 적용이 가능하다.
- 만약에 동시 사용자 수가 65536개를 초과한다면 동시접속이 불가능해서 오류가 발생한다고 한다 그래서 공인 IP 풀을 사용한다고 한다.
## 7.1.4 SNAT과 DNAT
- NAT를 사용해 네트워크 주소를 변환할 때 어떤 IP를 변환하는지에 따라 두 가지로 구분
  - SNAT(Source NAT) : 출발지 주소를 변경하는 NAT
    - 사설에서 공인으로
    - 사설에서 다른 사설 IP로 -> 대외계
  - DNAT(Destination NAT) : 도착지 주소를 변경하는 NAT
    - 로드 밸런서에서 많이 사용 : VIP에서 실제 IP로
    - 하나의 서비스에 대해서 여러 개의 대외사를 사용하는 경우 -> NAT에 도착지에 대한 네트워크 대역대를 넣어줌 -> 그러면 대외사가 추가되어도 사내 서버는 알 필요가 없음
## 7.1.5 동적 NAT과 정적 NAT
- 동적 NAT
  - 출발지와 목적지가 모두 정의된 것이 아니라 다수의 IP 풀에서 정해지므로 최소한 출발지나 목적지 중 한 곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정
  - NAT가 필요한 IP 풀에서 어떤 IP로 매핑될 것인지 판단해 NAT를 수행하는 시저에 NAT 테이블 만들어서 관리
  - NAT 테이블은 설정된 시간 동안 유지되고 일정 시간 동안 통신이 없으면 다시 사라진다.
- 정적 NAT
  - 출발지와 목적지 매핑 관계가 특정 IP로 사전에 정의된 것이므로 1:1 NAT라고 부르기도 한다.

      
