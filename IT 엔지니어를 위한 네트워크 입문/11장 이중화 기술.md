## 게이트웨이 이중화
### 게이트웨이 이중화란
- 특정 호스트가 동일한 서브넷에 있는 내부 네트워크와 통신할 때는 ARP를 직접 브로드캐스트해 출발지와 목적지가 직접 통신한다. 이는 L2 즉 맥주소만으로 통신이 가능하기 때문에 L2 통신이라고도 부른다.
- 그러나 외부 네트워크와 통신하기 위해서 L3 장비인 게이트웨이가 필요하다
- 이 장비에 장애가 발생하면 외부 네트워크와 통신할 수 없다. 그래서 두 개의 게이트웨이를 둬서 이중화를 시켰다고 하자. 이 때 발생할 수 있는 장애는 어떤 것이 있을까?
  ![image](https://github.com/user-attachments/assets/aa530da7-4370-4f65-bf2a-9bd30dd127e0)
  - 게이트웨이 자체의 장애
  - 게이트웨이 하단에 네트워크 인터페이스의 장애 혹은 케이블, 모듈의 장애
  - L2 장비인 스위치의 장애
- 이중화를 진행했음에도 장애가 전파된 이유는 하단의 장비들이 장애가 난 게이트웨이만을 바라보고 있었기 때문이다. 이는 두 개의 게이트웨이의 IP 주소가 다르기 때문인데
- 그렇다면 이중화된 게이트웨이의 주소를 같게 한다면 문제될 것이 없다. 이 때 사용하는 프로토콜이  **FHRP(First Hop Redundancy Protocol)** 라는 게이트웨이 이중화 프로토콜이다.
  ![image](https://github.com/user-attachments/assets/028273e0-5b46-4739-b0b7-81a710151122)

  - 게이트웨이 이중화 프로토콜을 사용하면 두 라우터는 실제 IP 외에 추가로 가상 IP 주소와 가상 IP에 대한 맥주소를 동일하게 가진다.
  - 가상 IP를 갖는 그룹 내에서 우선순위가 높은 장비가 Active 상태로 유지된다. 그리고 여기에 연결된 하단 장비들은 이 Active한 게이트웨이를 바라본다. 해당 장비가 문제가 발생하는 경우 Standby인 장비로 요청이 가게 된다.

### FHRP 
- 우선순위를 정해서 어떤 게이트웨이 장비를 Active로 할 것인지 정한다. 값이 높을수록 우선순위가 높다
- 게이트웨이끼리 같은 그룹임을 나타내기 위해사 그룹 ID를 설정한다. 이 그룹 ID를 가지고 가상 MAC주소를 만든다.
- 하단 네트워크 장비가 게이트웨이 장비를 인식하기 위해서 ARP를 보내면 게이트웨이 장비 중에서 Active한 장비가 응답하기 때문에 하단에 있는 네트워크 장비를 이를 게이트웨이 장비로 인식한다.
- Active 장비에서 장애가 발생하면 Standby로 교체되는데 이 때 Mac 주소 테이블만 교체되기 때문에 하단에 있는 네트워크 장비를 아무런 교체 작업이 일어나지 않아도 된다.
  - 여기서 나는 왜 Mac 주소 테이블이 변경되는지 의문이 있었는데 생각해보니 해당 가상 mac 주소를 갖는 포트가 무엇인지 바꿔줘야 하기 때문이다.
  - 기존에는 Active의 포트였다면 장애 발생 이후에는 Standby로 바꿔야 한다.
- FHRP의 표준 프로토콜은 VRRP이다
  - VRRP의 초기 상태
    ![image](https://github.com/user-attachments/assets/d52199a3-d240-4223-b3a7-ee4bf9d2991a)
    - VRID는 앞서 배운 그룹 아이디이다.
    - 우선순위는 각각 110과 기본값인 100이다
    - 마스터 즉 Active를 선출하기 위해서 각 장비는 Hello 패킷을 주고 받는다. 3회 이상 수신하지 못하면 상대를 비정상으로 간주해서 자신이 마스터 장비가 된다. 해당 Hello 패킴은 멀티캐스트 주소이다.
  - 예시
    ![image](https://github.com/user-attachments/assets/386c5fdb-825b-431a-b2ee-d5b98b658add)
    - (1) 먼저 자신의 진짜 IP
    - (2) 그룹 아이디  : 하나의 네트워크에는 중복된 그룹아이디가 있으면 안된다. 왜냐하면 이를 바탕으로 가상 MAC 주소를 만들기 때문이다. 그래서 다른 네트워크에서는 같은 그룹 아이디를 가질 수 잇다.
    - (3) 가상 IP
    - (4) 본인의 우선순위 : 기본값은 100이다. 값이 클수록 우선순위가 높다.
    - (5) 특정조건을 만족하지 않을 때 우선순위를 조절하기 위한 설정 : 해당 예시는 헬스체크를 했지만 실패하면 우선순위를 20 낮춘다.
    - (6) preempt standby 장비가 자동으로 자신이 우선순위가 높은 경우 active 상태로 바꾸는 기능이다. 기본은 꺼져 있다.
### 올 액티브 게이트웨이 이중화
- 앞서 배운 것은 Active와 StandBy이다. 이는 만약 요청이 Standby로 오는 경우 이 요청을 다시 Active에 보낸다.
- 하지만 이는 둘 다 사용할 수 있음에도 한 장비는 놀고 있으며 불필요하게 우회가 발생해서 낭비가 있다.
- 그래서 액티브액티브 모드로 설정할 수 있다.

### 애니케스트 게이트웨이 
- 물리적으로 다른 곳에 있지만 마치 하나의 네트워크처럼 보이게 하는 SDN 네트워크가 있다.
- 만약에 서울과 대구에 있다고 하면 서울에서 외부로 보내기 위해서 대구에 있는 게이트웨이 장비를 거쳐야 한다고 생각하면 굉장히 비효율적이다.
- 애니캐스트 게이트웨이는 지리적 위치까지 고려한다.

### 게이트웨이 고려사항
#### 가상화 서버 내의 서로 다른 네트워크를 가진 서버 간 통신
![image](https://github.com/user-attachments/assets/07188d8a-07c3-42ea-b0a1-339b303bfb77)
- 비효율적이지만 외부 게이트웨이를 이용함
#### 동일한 스위치에 연결된 서로 다른 네트워크를 가진 서버 간 통신(가상화 포함)
- 앞 경우와 비슷하게 외부에 있는 게이트웨이를 거쳐아 한다.
- 하지만 최근에 들어서 위와 같이 외부 게이트웨이를 거치지만 않고 가상화 내에서 게이트웨이를 거치도록 할 수도 잇다.
  ![image](https://github.com/user-attachments/assets/ba62d3f0-f458-4009-afb5-8d67b0a0c549)

