# 2장 카프카 설치하기
배우는 내용
- 아파치 주키퍼 설치(브로커의 메타 데이터를 저장)하는 방법
- 아파치 카프카를 설치하기 위한 기본적인 설정 옵션
- 브러커를 실행하는 데 적합한 하드웨어를 선택하는 기준
- 여러 개의 카프카 브로커를 하나의 클러스터로 구성하는 방법
- 카프카를 프로덕션 환경에서 사용할 때 알아 두어야 할 것들
## 2.1 환경 설정
- 운영체제 선택하기
  대체로 리눅스 환경을 권장
- 자바 설치하기
  주키퍼와 카프카 모두 OpenJDK 기반 자바 구현체에서 원활히 작동함
  최신 버전을 다운받을 것을 권장
- 주키퍼 설치하기
  >주키퍼란
  카프카 클러스터의 메타데이터와 컨수머 클라이언트에 대한 정보를 저장
  설정 정보 관리, 이름 부여, 분산 동기화, 그룹 서비스를 제공하는 중앙화된 서비스
  - 독립 실행 서버
  - 주키퍼 앙상블
    - 주키퍼는 고가용성을 보장하기 위해서 앙상블이라 불리는 클러스터 단위로 작동 = 주키퍼도 단일 장애 지점을 피하기 위해서 여러 대의 서버로 운영
    - 이 앙상블은 홀수 개의 서버를 가지도록 권장되며, 안의 서버들이 과반수이상 작동해야 하기 때문이다.
      또한 5개의 노드 크기를 고려하라고 한다. 그 이유는 하나의 서버의 설정을 변경하면 중지하고 다시 시작해야 하는데 2대 이상의 노드 정지를 받아낼 수 없다면 위험이 따르기 때문이라고 한다.
      그러나 9대 이상의 서버를 유지하는 것도 권장하지 않는다고 한다. 그래서 5,7대를 유지하고 옵저버 서버를 차라리 추가하라고 권장한다.
      나는 이 부분을 읽으면서 몇가지 궁금한 점이 발생했고 그리고 몽고 디비의 복제셋과 비슷하게 관리되어짐을 깨달았다.
      - 왜 9대 이상일 때 성능 저하가 발생할까?
       chatGPT에 따르면
       ```
        카프카는 리더 선출과 데이터 일관성 유지를 위해 합의 프로토콜(예: ZooKeeper)을 사용합니다. 노드 수가 많아질수록 합의 과정에서 모든 노드가 동일한 상태를 유지하려고 서로 간의 메시지를 주고받는 작업이 증가합니다. 이로 인해 다음과 같은 성능 저하가 발생할 수 있습니다:
        - 합의 지연: 노드가 많아질수록 모든 노드 간의 합의에 필요한 시간이 늘어납니다. 특히 장애가 발생했을 때, 새로운 리더를 선출하거나 복구하는 과정에서 지연이 더 커질 수 있습니다.
        - 통신 오버헤드 증가: 노드가 9대를 넘어서면, 각 노드가 서로 데이터를 동기화하고 일관성을 유지하기 위해 통신하는 횟수가 급격히 증가합니다. 이에 따라 네트워크 및 처리 오버헤드가 늘어나 성능이 떨어질 수 있습니다.
        따라서 카프카는 노드 수를 9대 이하로 유지하도록 권장하며, 필요시 클러스터를 분리해 여러 클러스터로 운영하는 방식을 추천하는 경우가 많습니다.
       ```
      - 왜 5대와 7대일까? 2개 이상의 노드 정지를 받아낼 수 없으면 왜 위험이 따르는가?
       ```
       1. 왜 5대나 7대를 유지하라는가?
       홀수 노드 사용의 장점: 카프카와 같은 분산 시스템은 과반수 합의에 따라 리더 선출과 클러스터 상태를 유지합니다. 홀수 개의 노드를 사용하면 과반수 결정이 명확해 합의 과정에서 효율적입니다.
       안정성과 성능의 균형:
       - 5대: 2대까지 장애를 허용할 수 있으므로 안정적이면서도 운영 비용을 최소화합니다.
       - 7대: 3대까지 장애 허용이 가능하여 더 높은 안정성을 제공합니다.
       - 장애 내성: 홀수 개의 노드를 사용함으로써 재시작이나 장애가 발생할 때도 과반수를 쉽게 유지할 수 있습니다. 예를 들어, 5대에서 2대가 중지돼도 과반수를 유지하지만, 6대처럼 짝수 개를 사용하면 3대가 중지되었을 때 과반수를 유지할 수 없어 더 불안정해집니다.
       2. 9대 이상 사용을 권장하지 않는 이유
       합의 프로토콜 성능 저하: 9대 이상의 노드가 있으면, 카프카의 리더 선출이나 데이터 일관성을 맞추기 위한 합의 과정에서 네트워크 통신과 검증 작업이 급격히 늘어납니다.
       - 오버헤드 증가: 모든 노드가 서로 상태를 확인하고 일관성을 유지하려고 할 때, 네트워크와 리소스 오버헤드가 커지며 성능 저하가 발생할 수 있습니다. 특히 장애가 발생했을 때 새로운 리더를 빠르게 선출하기 어려워집니다.
       - 효율적 관리의 한계: 9대 이상은 추가적인 관리와 네트워크 비용이 발생하며, 안정성 향상보다 성능 저하 위험이 커져 클러스터 관리가 어려워집니다.
      ```
       
       
