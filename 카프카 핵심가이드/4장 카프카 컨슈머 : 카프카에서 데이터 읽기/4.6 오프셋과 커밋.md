## 4.6 오프셋과 커밋
- poll()을 호출할 때마다 카프카에 쓰여진 메시지 중 컨슈머 그룹에 속한 컨슈머들이 아직 읽지 않은 레코드들을 리턴한다.
- 이는 컨슈머가 읽은 레코드가 무엇인지 기록한다는 것이고 이는 커밋을 통해서 이뤄진다.
- 카프카는 개별 레코드를 커밋하지 않고 컨슈머가 파티션에서 성공적으로 처리해 낸 마지막 메시지를 커밋한다. = 그 앞의 모든 메세지들 역시 성공적으로 처리되었음을 암묵적으로 나타낸다.
- 컨슈머가 어떻게 오프셋을 커밋하는가?
  - 이는 카프카에서 특수 토픽인 **__consumer_offsets** 이라는 토픽에 각 파티션별로 커밋된 오프셋을 업데이하도록 하는 메시지를 보낸다.
  - 정상적일 때는 이용되지 않지만 리밸러싱이 일어날 때는 컨슈머가 다른 파티션을 할당받을 수 있기 때문에 어디까지 처리되었는지 알아야하고 이 때 사용된다.
- 만약 마지막으로 커밋한 오프셋이 클라이언트가 처리한 메세지의 오프셋보다 작을 경우 -> 리벨런싱이 일어나고 나서 중복 처리가 발생한다.
  - 이는 커밋하고 나서 뒤에 불러온 배치 메시지들이 처리되기 전에 poll.interval.ms가 경과되어 리밸런싱이 일어나든지 하는 경우일 수 있다.
    ![image](https://github.com/user-attachments/assets/b93e99f4-b4e9-4fee-a156-2a0ba6a1b7a5)
- 만약에 마지막으로 커밋한 오프셋이 클라이언트가 처리한 메시지 오프셋보다 크다면 -> 리밸런싱이 일어나고 나서 누락이 발생한다.
  ![image](https://github.com/user-attachments/assets/b7d3bae4-8831-448b-9f9c-0b5e7ed6b0a9)
- 어느 오프셋이 커밋되는가?
  - poll() 메서드가 리턴한 마지막 오프셋의 바로 다음 오프셋
