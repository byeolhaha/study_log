## 4.1.1 컨슈머와 컨슈머 그룹
## 4.1.2 컨슈머 그룹과 파티션 리벨런스
> 리밸런스: 컨슈머 그룹에 할당된 파티션을 다른 컨슈머에게 할당해주는 작업
- 파티션 할당 전략
  1. 조급한 리밸런스
     - 우선 모든 컨슈머가 자신에게 할당된 파티션을 포기
     - 파티션을 포기한 컨슈머 모두가 다시 그룹에 참여한 뒤에 새로운 파티션을 할당받고 읽기 작업 개제
     - 근본적으로 전체 컨슈머 그룹에 대해 짧은 시간동안 작업을 멈추게 하며 그 시간의 길이는 컨슈머 그룹의 크기와 매개 변수에 영향을 받는다.
  2. 협력적 리밸런스
     - 한 컨슈머에게 할당되어 있던 파티션만을 다른 컨슈머에게 재할당
     - 그래서 재할당되지 않은 파티션에서 레코드를 읽고 멈추지 않고 자기 할 일을 할 수 있다. 조급한 리밸런스에 비해서 스탑더월드가 발생하지 않는다.
     - 이 작업은 크게 두 단계로 일어난다.
       - 컨슈머 그룹 리더가 다른 컨슈머들에게 각자에게 할당된 파티션 중 일부가 재할당 될 것이라고 통보하면 컨슈머들은 해당 파티션에서 데이터를 읽어오는 작업을 멈추고 소유권을 포기한다.
       - 컨슈머 그룹 리더가 이 포기된 파티션들을 새로 할당한다.
     - 이 방식은 컨슈머 그룹이 커서 리밸런싱 시간이 길게 발생될 것으로 예상되는 경우 아주 중요한 부분으로 작용한다.
- 하트비트 = 브로커가 죽은 컨슈머를 알 수 있는 방법
  - 컨슈머는 해당 컨슈머 그룹의 그룹 코디네이터 역할을 지정받은 브러커에게 하트비트를 전송해서 멤버십과 할당된 파티션에대한 소유권을 유지한다.
  - 만약에 이게 일정 시간 오지 않아 세션 타임 아웃이 오면 죽었다고 판단해서 리밸런싱이 일어난다.
- 파티션은 어떻게 컨슈머에게 할당되는가?
  - 일단 컨슈머가 그룹에 참여하고 싶을 때 그룹 코디네이터에게 참여 요청이 JoinGroup 요청을 보낸다.
  - 그러면 처음 요청을 보낸 컨슈머가 리더가 된다. 이 리더는 그룹에 속한 컨슈머들에게 파티션을 할당해주는데 이 할당 방식은 PartitionAssinger 인터페이스 구현체에 의해서 결정된다.
