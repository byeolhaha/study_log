# 샤딩 소개
## 샤딩이란
### 클러스 구성요소 이해하기
## 단일 장비 클러스터에서의 샤딩
일단 책에서 ShardingTest클래스로 테스트에서 사용할 수 있는 샤딩을 제공하고 있으나 이게 Mongodb 6.XX버전부터 deprecated되었다.🫣
그래서 내가 직접 샤딩을 구성해야 했다.

1. 먼저 구성 서버를 만들어준다. 구성 서버도 마찬가지로 복제 셋을 구성한다.
   ```
   mongod --configsvr --replSet configReplSet --port 37019 --dbpath /Users/kimbyeol/data/configdb  --bind_ip localhost
   ```

   ```
   mongod --configsvr --replSet configReplSet --port 37031 --dbpath /Users/kimbyeol/data/configdb_1  --bind_ip localhost
   ```

   ```
   mongod --configsvr --replSet configReplSet --port 37032 --dbpath /Users/kimbyeol/data/configdb_2  --bind_ip localhost
   ```

   그리고 나서 이제 이에 대해서 복제 셋으로 설정하자.
   ```
   mongosh --port 37019
   rsconf = {_id:"configReplSet", members:[{_id:0,host:"localhost:37019"},{_id:1,host:"localhost:37031"},{_id:2,host:"localhost:37032"}]}
   rs.initiate(rsconf)
   ```
2. 샤드를 구성한다. 샤드들도 복제 셋으로 구성한다. 나는 2개의 샤드를 만들었다. 각 샤드마다 3개의 복제 셋을 가지고 있다.
   - 샤드 1 만들기 각자 다른 터미널에 입력해야 한다. 
     ```
     mongod --shardsvr --replSet shard1ReplSet --port 37020 --dbpath /Users/kimbyeol/data/shard1 --bind_ip localhost
     mongod --shardsvr --replSet shard1ReplSet --port 37041 --dbpath /Users/kimbyeol/data/shard1_1 --bind_ip localhost
     mongod --shardsvr --replSet shard1ReplSet --port 37042 --dbpath /Users/kimbyeol/data/shard1_2 --bind_ip localhost
     ```
     그리고 나서 복제 셋을 설정한다.
     ```
     mongosh --port 37020
     rsconf = {_id:"shard1ReplSet", members:[{_id:0,host:"localhost:37020"},{_id:1,host:"localhost:37041"},{_id:2,host:"localhost:37042"}]}
     rs.initiate(rsconf)
     ```
   - 샤드 2
     ```
     mongod --shardsvr --replSet shard2ReplSet --port 37021 --dbpath /Users/kimbyeol/data/shard2 --bind_ip localhost
     mongod --shardsvr --replSet shard2ReplSet --port 37051 --dbpath /Users/kimbyeol/data/shard2_1 --bind_ip localhost
     mongod --shardsvr --replSet shard2ReplSet --port 37052 --dbpath /Users/kimbyeol/data/shard2_2 --bind_ip localhost
     ```
     그리고 나서 복제 셋을 설정한다.
     ```
     mongosh --port 37021
     rsconf = {_id:"shard2ReplSet", members:[{_id:0,host:"localhost:37021"},{_id:1,host:"localhost:37051"},{_id:2,host:"localhost:37052"}]}
     rs.initiate(rsconf)
     ```
3. 이제 어떤 데이터가 어떤 샤드에 들어있는지 컨텐츠 목차가 있는 monogs 서버를 만들어서 샤드를 등록하자
   ```
   mongos --configdb configReplSet/localhost:37019 --bind_ip localhost --port 37061
   ```
   ```
   mongosh --port 37061
   ```
   샤드를 등록해보자 하나씩만 등록해도 알아서 가져올 것이다.
   ```
   [direct: mongos] test> sh.addShard("shard1ReplSet/localhost:37020")
   [direct: mongos] test> sh.addShard("shard2ReplSet/localhost:37021")
   ```
   ```
   [direct: mongos] test> sh.status()
   shardingVersion
   { _id: 1, clusterId: ObjectId('66eec70eafadd1f3bc7928cc') }
    ---
   shards
   [
    {
    _id: 'shard1ReplSet',
    host: 'shard1ReplSet/localhost:37020,localhost:37041,localhost:37042',
    state: 1,
    topologyTime: Timestamp({ t: 1726925569, i: 2 })
   },
   {
    _id: 'shard2ReplSet',
    host: 'shard2ReplSet/localhost:37021,localhost:37051,localhost:37052',
    state: 1,
    topologyTime: Timestamp({ t: 1726925581, i: 2 })
    }
   ]
   ---
   active mongoses
    [ { '7.0.11': 1 } ]
   ---
   autosplit
   { 'Currently enabled': 'yes' }
   ---
   balancer
   {
   'Currently enabled': 'yes',
   'Currently running': 'no',
   'Failed balancer rounds in last 5 attempts': 0,
   'Migration Results for the last 24 hours': 'No recent migrations'
   }
   ---
   databases
   [
    {
    database: { _id: 'config', primary: 'config', partitioned: true },
    collections: {}
   }
   ]
   ```

이제부터는 데이터베이스에 샤딩을 활성화하고
그다음에 키를 등록한다.
```
sh.enableSharding("acconts")
```
```
sh.shardCollection("accounts.users",{"username":1})
```

몇 분 기다리고 나서 sh.status()를 하면 도규먼트들이 키에 따라서 천크되어져 있고 반반씩 각 샤드들에 분배되어져 있는 것을 확인할 수 있다.
그런데 나는 어째서인지 한 샤드에만 분배되어져 있어서 좀 애를 먹었다.
여러가지 원인이 있다고 하는데
- 천크의 크기가 작거나
- 밸러서가 꺼져있거나
하는 문제였는데 아직도 모르겠다.

따라서 샤드키를 가지고 find()를 하면 해당 키를 가지고 있는 샤드로 가서 검색을 한다. => 이를 타켓 쿼리라고 한다.
이는 .explain()과 함께 출력하면 나온다.

하지만 샤드키를 가지고 조회하지 않으면 모든 샤드를 검색한다. => 이를 분산 수집 쿼리라고 한다.
