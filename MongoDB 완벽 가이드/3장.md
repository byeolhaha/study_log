({ì¡°ê±´},{í–‰ìœ„})

# 3.3 ë„íë¨¼íŠ¸ ê°±ì‹ 

## 3.3.5 ê°±ì‹ í•œ ë„íë¨¼íŠ¸ ë°˜í™˜

findAndUpdate

- í•œ ë²ˆì˜ ì—°ì‚°ìœ¼ë¡œ í•­ëª©ì„ ë°˜í™˜í•˜ê³  ê°±ì‹ 
- ì¦‰, ìˆ˜ì •ë˜ê¸° ì „ê°’ì„ ë°˜í™˜
    - but, `returnNewDocument` í•„ë“œë¥¼ trueë¡œ ì„¤ì •í•˜ë©´ ê°±ì‹ ëœ ë„íë¨¼íŠ¸ë¥¼ ë°˜í™˜

# 4.3 í˜• íŠ¹ì • ì¿¼ë¦¬

## 4.3.3 ë°°ì—´ì— ì¿¼ë¦¬í•˜ê¸°

### `$slice`ë°°ì—´ì—ì„œ ë²”ìœ„ë¥¼ ì œí•œí•  ë•Œ ì‚¬ìš©

`db.post.find()`

```jsx
{
  _id: ObjectId('66b9eb671e80ecf8f87cc028'),
  coments: [
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
{
  _id: ObjectId('66b9eb791e80ecf8f87cc029'),
  coments: [
    {
      name: 'joe',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    },
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

`db.post.findOne({},{"coments":{"$slice":10}})`  : ë¨¼ì € ë‹¬ë¦° ê²Œì‹œê¸€ì˜ ë¨¼ì € ë‹¬ë¦° ëŒ“ê¸€ 10ê°œ ë°˜í™˜

```jsx
{
  _id: ObjectId('66b9eb671e80ecf8f87cc028'),
  coments: [
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

`db.post.findOne({},{"coments":{"$slice":-10}})` : ë¨¼ì € ë‹¬ë¦° ê²Œì‹œê¸€ì˜ í›„ì— ë‹¬ë¦° ëŒ“ê¸€ 10ê°œ ë°˜í™˜

```jsx
{
  _id: ObjectId('66b9eb671e80ecf8f87cc028'),
  coments: [
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

`db.post.findOne({"_id":ObjectId('66b9eb791e80ecf8f87cc029')},{"coments":{"$slice":[1,2]}})`  : ë²”ìœ„ë¡œ ê²€ìƒ‰

```jsx
{
  _id: ObjectId('66b9eb791e80ecf8f87cc029'),
  coments: [
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    },
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    }
  ]
}
```

`db.post.findOne({"_id":ObjectId('66b9eb791e80ecf8f87cc029')},{"coments":{"$slice":-1}})` : ë§ˆì§€ë§‰ ëŒ“ê¸€

```jsx
{
  _id: ObjectId('66b9eb791e80ecf8f87cc029'),
  coments: [
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

### ì¼ì¹˜í•˜ëŠ” ë°°ì—´ ìš”ì†Œì˜ ë°˜í™˜

`db.post.find({"coments.name":"byeol"})`  : ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ëª¨ë“  ê²Œì‹œê¸€

```jsx
{
  _id: ObjectId('66b9eb791e80ecf8f87cc029'),
  coments: [
    {
      name: 'joe',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    },
    {
      name: 'jain',
      email: 'j35635aa@gmail.com',
      contents: 'ì•ˆë…•í•˜ì„¸ìš”'
    },
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

`db.post.find({"coments.name":"byeol"},{"coments.$":1})`  : ì¼ì¹˜í•˜ëŠ” ë°°ì—´ì˜ ìš”ì†Œë§Œ ë°˜í™˜, ë¬¼ë¡  ë‹¹ì—°íˆ `_id` í•„ë“œ í¬í•¨ + **ê° ë„íë¨¼íŠ¸ì— ì¼ì¹˜í•˜ëŠ” ì²«ë²ˆì§¸ ìš”ì†Œ**ë¥¼ ë°˜í™˜

```jsx
{
  _id: ObjectId('66b9eb671e80ecf8f87cc028'),
  coments: [
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
{
  _id: ObjectId('66b9eb791e80ecf8f87cc029'),
  coments: [
    {
      name: 'byeol',
      email: 'byeol@naver.com',
      contents: 'hello'
    }
  ]
}
```

### ë°°ì—´ ë° ë²”ìœ„ ì¿¼ë¦¬ì˜ ìƒí˜¸ ì‘ìš©

<aside>
ğŸ’¡ **ë„íë¨¼íŠ¸ë¼ë¦¬ ê°™ì€ í‚¤ì— ëŒ€í•´ì„œ ê°’ì´ ë°°ì—´ê³¼ ë¹„ë°°ì—´ ìš”ì†Œë¡œ ì„ì—¬ ìˆì„ ë•Œ ë²”ìœ„ ì¿¼ë¦¬ë¥¼ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?**

</aside>

`db.test.find()`

```jsx
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02a'),
  x: 5
}
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02b'),
  x: 15
}
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02c'),
  x: 25
}
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02d'),
  x: [
    5,
    20
  ]
}
```

- `db.test.find({"x":{"$gt":10, "$lt":20}})`

```jsx
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02b'),
  x: 15
}
{
  _id: ObjectId('66b9f2f21e80ecf8f87cc02d'),
  x: [
    5,
    20
  ]
}
```

â‡’ ì›í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë°°ì—´ ìš”ì†Œì—ì„œ ë²”ìœ„ ì¿¼ë¦¬ê°€ ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠëŠ”ë‹¤.

- `db.test.find({"x":{"$elemMatch":{"$gt":10, "$lt":20}}})`: elemMatchëŠ” ë°°ì—´ì— ëŒ€í•´ì„œë§Œ ì ìš©ë˜ê³  ë¹„ë°°ì—´ì— ëŒ€í•´ì„œëŠ” ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë¬¸ì œê°€ ì¡´ì¬í•œë‹¤.

```jsx
null
```

- â­ï¸`db.test.find({"x":{"$gt":10, "$lt":20}}).min({"x":10}).max({"x":20})`

: ìœ„ì™€ ê°™ì´ ì ìš©í•˜ë©´ ìœ„ì—ì„œ ë°œìƒí•œ ë¬¸ì œì ë“¤ì´ í•´ê²°ëœë‹¤. í•˜ì§€ë§Œ â€œxâ€ì— ì¸ë±ìŠ¤ê°€ ê±¸ë ¤ìˆì§€ ì•Šì€ ìƒíƒœì—ì„œ ìœ„ ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ë¼ëŠ” ë§ì´ ëœ¬ë‹¤.

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/137bc5c7-5be4-4ef9-82b3-d4f8af082731/63f4a727-f420-4de6-aff1-a6b5410c233d/image.png)

**`ê·¸ë ‡ë‹¤ë©´ ë°°ì—´ê³¼ ë¹„ë°°ì—´ì´ ì„ì—¬ìˆëŠ” í•„ë“œì— ëŒ€í•´ì„œ ë²”ìœ„ ì¿¼ë¦¬ë¥¼ í•˜ë ¤ë©´ ë¬´ì¡°ê±´ ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ê±¸ê¹Œ?`**

## 4.3.4 ë‚´ì¥ ë„íë¨¼íŠ¸ ì¿¼ë¦¬í•˜ê¸°

ë‚´ì¥ ë„íë¨¼íŠ¸ë¥¼ ë‹¤ë£¨ëŠ” ë°©ë²•

- ë„íë¨¼íŠ¸ ì „ì²´ : ë¹„ì¶”ì²œ
`db.people.find()`
    
    ```jsx
    {
      _id: ObjectId('66ba01861e80ecf8f87cc02e'),
      name: {
        first: 'kim',
        last: 'byeol'
      },
      age: 45
    }
    
    ```
    
    `db.people.find({"name":{"first":"kim","last":"byeol"}})`
    
    ```jsx
    {
      _id: ObjectId('66ba01861e80ecf8f87cc02e'),
      name: {
        first: 'kim',
        last: 'byeol'
      },
      age: 45
    }
    ```
    
    - ë‹¨ì ë“¤ì´ ëˆˆì— ë³´ì´ê¸° ì‹œì‘í•œë‹¤.
        - ìˆœì„œê°€ ë°”ë€Œë©´ ì¿¼ë¦¬ ê²€ìƒ‰ì´ ì•ˆëœë‹¤.
            
            `db.people.find({"name":{"last":"byeol","first":"kim"}})`
            
            ```jsx
            null
            ```
            
        - ì¤‘ê°„ì— í•„ë“œê°€ í•˜ë‚˜ ì¶”ê°€ë˜ë©´ ê²€ìƒ‰ì´ ì•ˆëœë‹¤.
            - ì‚¬ì‹¤ ì•„ë˜ ì¿¼ë¦¬ë¼ê³  ìƒê°í–ˆëŠ”ë° ê³„ì† ëŒ€ì²´ë¨
            `db.people.update({"name":{"first":"kim","last":"byeol"}},{"$set":{"name":{"middle":"song"}}})`  : ë‚´ê°€ ì˜ˆìƒí•œ ê²°ê³¼ê°€ ì•ˆë‚˜ì˜´ í•„ë“œë¥¼ ë¦¬ì…‹í•˜ê³  ì¶”ê°€í•´ë²„ë¦¼
                
                ```jsx
                {
                  _id: ObjectId('66ba036d1e80ecf8f87cc02f'),
                  name: {
                    middle: 'song'
                  },
                  age: 45
                }
                ```
                
                ì•„ë˜ ì¿¼ë¦¬ê°€ ì˜¬ë°”ë¥¸ ì¿¼ë¦¬
                
                `db.people.updateOne( {"name.first": "kim", "name.last": "byeol"},
                   { $set: {"name.middle": "your_middle_name"} })`
                
                ```jsx
                {
                  _id: ObjectId('66ba03d51e80ecf8f87cc031'),
                  name: {
                    first: 'kim',
                    last: 'byeol',
                    middle: 'your_middle_name'
                  },
                  age: 45
                }
                ```
                
                - `db.people.find({"name":{"first":"kim","last":"byeol"}})`
                    
                    ```jsx
                    null
                    ```
                    
- ë„íë¨¼íŠ¸ ë‚´ í‚¤/ê°’ ìŒ : ì¶”ì²œ â­ï¸
`db.people.find({"name.first":"kim","name.last":"byeol"})`
    
    ìœ„ì™€ ê°™ì´ ë‚´ì¥ ë„íë¨¼íŠ¸ëŠ” ì  í‘œê¸°ë²•ì„ ì‚¬ìš©í•˜ì
    
    ```jsx
    
      _id: ObjectId('66ba03d51e80ecf8f87cc031'),
      name: {
        first: 'kim',
        last: 'byeol',
        middle: 'your_middle_name'
      },
      age: 45
    }
    ```
    
- ë³µì¡í•œ ë‚´ì¥ ë„íë¨¼íŠ¸
`db.post.find()`
    
    ```jsx
    {
      _id: ObjectId('66ba06241e80ecf8f87cc032'),
      content: 'ì•ˆë…•í•˜ì„¸ìš” í…ƒë°­ì„ ì†Œê°œí•©ë‹ˆë‹¤.',
      comments: [
        {
          author: 'joe',
          score: 3,
          comment: 'nice post'
        },
        {
          author: 'byeo',
          score: 10,
          comment: 'good'
        }
      ]
    }
    ```
    
    - ì „ì²´ ë„íë¨¼íŠ¸ ì¿¼ë¦¬
    `db.post.find({"comments":{"author":"joe","score":{"$gt":3}}})`
        
        ```jsx
        null
        ```
        
        ì™œëƒí•˜ë©´ commentsëŠ” comment í•„ë“œë„ ê°€ì§€ê³  ìˆëŠ”ë° ë“±ì¥í•˜ì§€ ì•ŠìŒ
        
    - ë‚´ì¥ ë„íë¨¼íŠ¸ ì¿¼ë¦¬
        
        `db.post.find({"comments.author":"joe","comments.score":{"$gt":3}})`
        
        `db.post.find({"comments": {"$elemMatch" : {"author" : "joe","score":{"$gt":3}}}})`
        

# 4.4 $where ì¿¼ë¦¬

- ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•¨
- BSON â†’ Javascriptë¡œ ë°”ê¾¸ëŠ” ê³¼ì •ì´ ë°œìƒí•´ ì†ë„ê°€ ëŠë¦¬ë‹¤.
- êµ¬ì²´ì ì¸ ì¿¼ë¦¬ë¥¼ ë‚˜ê°ˆ ë•Œ ì‚¬ìš©

# 4.5 ì»¤ì„œ

- ì…€ì—ì„œ ì»¤ì„œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²• â‡’ ì§€ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ê¸°
    
    ```jsx
    for( i=0;i<100;i++) {
       db.collection.insertOne({x:i});
    }
    var cursor = db.collection.find()
    ```
    
    - ê²°ê³¼ ì–»ê¸°
        
        ```jsx
        cursor.forEach(function(x){
         print(x.x);
        } );
        ```
        
        ```jsx
        var cursor = db.collection.find()
        while(cursor.hasNext()) {
          obj = cursor.next();
        }
        > { _id: ObjectId('66be079e9301ca6420f5e94a'), x: 99 }
        ```
        
    - ì¶”ê°€ ì¿¼ë¦¬í•˜ê¸°
        
        ```jsx
        var cursor = db.collection.find().sort({"x":1}).limit(1).skip(10)
        ```
        

## 4.5.1 ì œí•œ, ê±´ë„ˆë›°ê¸°, ì •ë ¬

- ì œí•œ
    - `db.collection.find().limit(3)`
- ê±´ë„ˆë›°ê¸°
    - `db.collection.find().skip(3)` : ì²˜ìŒ 3ê°œ
    - **í° ìˆ˜ë¥¼ ê±´ë„ˆë›°ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì´ë‹¤.**
- ì •ë ¬
    - `db.collection.find().sort({"x":-1})`
    
    ```jsx
    {
      _id: ObjectId('66be079e9301ca6420f5e94a'),
      x: 99
    }
    {
      _id: ObjectId('66be079e9301ca6420f5e949'),
      x: 98
    }
    ...
    ```
    
    - ë¹„êµ ìˆœì„œ : í•˜ë‚˜ì˜ í‚¤ì— ì—¬ëŸ¬ ìë£Œí˜•ì´ ì €ì¥ë  ìˆ˜ ìˆëŠ”ë° ì´ ë•Œ ì €ì¥ëœ ê°’ì˜ ì •ë ¬ ìˆœì„œ
        1. ìµœì†Ÿê°’
        2. null
        3. ìˆ«ì ( int, long, double, decimal)
        4. ë¬¸ìì—´
        5. ê°ì²´/ë„íë¨¼íŠ¸
        6. ë°°ì—´
        7. ì´ì§„ ë°ì´í„°
        8. ê°ì²´ ID
        9. ë¸”ë¦¬ì–¸
        10. ë‚ ì§œ
        11. íƒ€ì„ìŠ¤íƒ¬í”„
        12. ì •ê·œ í‘œí˜„ì‹
        13. ìµœëŒ“ê°’

## 4.5.2 ë§ì€ ìˆ˜ì˜ ê±´ë„ˆë›°ê¸° í”¼í•˜ê¸°

ë„íë¨¼íŠ¸ ìˆ˜ê°€ ì ì„ ë•ŒëŠ” skipì„ ì‚¬ìš©í•´ë„ ë¬´ë¦¬ê°€ ì—†ì§€ë§Œ skipì€ ìƒëµëœ ê²°ê³¼ë¬¼ì„ ëª¨ë‘ ì°¾ì•„ íê¸°í•˜ë¯€ë¡œ ê²°ê³¼ê°€ ë§ìœ¼ë©´ ëŠë ¤ì§„ë‹¤. 

### skipì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  í˜ì´ì§€ ë‚˜ëˆ„ê¸°

â‡’ ë²”ìœ„ ê²€ìƒ‰ì„ í•˜ë¼ëŠ” ë§

### ëœë¤ìœ¼ë¡œ ë„íë¨¼íŠ¸ ì°¾ê¸°

- ë¹„íš¨ìœ¨ì ì¸ ë°©ë²•
    
    ```jsx
    var total = db.foo.count();
    var random = Math.floor(Math.random()*total)
    db.foo.find().skip(random).limit(1)
    ```
    
    â‡’ ì „ì²´ ìˆ˜ë¥¼ ì„¸ê³ , ë§ì€ ìˆ˜ë¥¼ ê±´ë„ˆë›°ì–´ì•¼ í•¨
    
- íš¨ìœ¨ì ì¸ ë°©ë²• â‡’ ëœë¤í•œ ê°’ ìì²´ë¥¼ ìš”ì†Œë¡œ ì¶”ê°€í•˜ê¸°
    
    ```jsx
    db.people.insertOne({"name":"joe", "random":Math.random()})
    var random = Math.random()
    result = db.people.findOne({"random":{"$gt":random}})
    //ë§Œì•½ resultê°€ ë¹ˆê°’ì´ë©´
    if(result==null) {
       result = db.people.findOne({"random":{"$lte":random}})
    }
    ```