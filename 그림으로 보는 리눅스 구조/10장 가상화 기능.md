# 10장 가상화 기능
## 가상화 기능이란 무엇인가
>PC나 서버 등의 물리적인 기기에서 가상 머신을 동작시키는 소프트웨어 기능 및 그런 동작을 돕는 하드웨어 기능의 조합

아래의 용도의 경우 사용
- 1대의 물리 기기에 여러 시스템 가동 => 각각의 가상 머신을 고객이 빌려쓰는 IaaS
- 수십 대의 물리 기기로 구성된 시스템을 가상 머신으로 대체
- 레거시 시스템 수명 연장 : 하드웨어 지원이 끝난 오래된 시스템을 가상 머신에서 가동
- 어떤 OS에서 다른 OS 사용하기
- 개발, 테스트 환경 
## 가상화 소프트웨어
> 가상 머신의 생성, 삭제 관리 담당
가상화 소프트웨어는 물리 기기의 하드웨어 자원을 관리하고 가상 머신에 나눠준다.

- 물리 CPU : 물리 기기의 cpu => PCPU
- 가상 CPU : 가상 머신의 cpu => VCPU

![image](https://github.com/user-attachments/assets/3698defa-79a7-483e-ab1c-3bfd155e93c0)
가상화 소프트웨어와 가상 머신의 관계는 커널의 프로세스 관리 시스템과 프로스의 관계와 닮았다.

![image](https://github.com/user-attachments/assets/69506fa7-9798-40dd-9da9-a652a51b5026)

가상화 소프트웨어를 구현하는 방법
- 하드웨어에 직접 하이퍼바이저 가상화 소프트웨어를 설치하는 방법
- 기존 OS를 바탕으로 애플리케이션으로 동작하는 방법
- 유명한 소프트웨어
  - VM사의 각종 제품
  - 오라클의 버츄얼박스
  - 마이크로소프트사의 하이퍼V
  - 시트릭스 시스템즈사의 젠

## 이 장에서 사용하는 가상화 소프트웨어
세 종류의 소프트웨어를 조합해서 가상 머신 작성 및 관리
- KVM : 리눅스 커널이 제공하는 가상화 기능
- QEMU : CPU 및 하드웨어 에뮬레이터 , KVM과 같이 사용한다면 하드웨어 에뮬레이터만 사용
- virt - manager : 가상 머신 생성, 관리, 삭제를 지원

이 부분을 공부하면서 구체적으로 저 KVM과 QEMU가 무엇인지 그리고 에뮬레이터에 대한 뜻이 궁금해서 더 찾아보았다.

**에뮬레이션(emulation)**은 한 시스템이 다른 시스템의 동작을 모방하는 것을 의미합니다. 즉, 소프트웨어나 하드웨어가 자신의 원래 환경이 아닌 다른 환경에서 동작할 수 있도록 만드는 과정을 말합니다. 에뮬레이션을 통해 한 시스템에서 다른 시스템의 동작을 완벽하게 흉내 낼 수 있어, 호환되지 않는 하드웨어나 운영체제에서도 소프트웨어를 실행할 수 있습니다.

에뮬레이션의 핵심 요소
다른 아키텍처나 시스템의 동작을 재현: 에뮬레이터는 특정 하드웨어나 소프트웨어 환경을 모방하여, 그 환경에서 실행해야 하는 프로그램이 다른 환경에서도 정상적으로 동작하게 합니다. 예를 들어, x86 아키텍처에서 ARM 아키텍처의 프로그램을 실행할 수 있습니다.

정확한 동작 모방: 에뮬레이터는 모방 대상의 구체적인 동작을 최대한 동일하게 흉내 냅니다. 하드웨어나 소프트웨어가 실제로 어떻게 동작하는지 분석하고 이를 재현합니다.

에뮬레이션의 예시
1. 게임 콘솔 에뮬레이터:
  예를 들어, 오래된 닌텐도(Nintendo) 게임을 최신 컴퓨터에서 실행하고 싶다면, 닌텐도 에뮬레이터를 사용합니다. 이 에뮬레이터는 닌텐도 하드웨어의 동작을 흉내 내어, 게임을 PC에서 실행할 수 있게 합니다.
   여기서 에뮬레이터는 닌텐도의 CPU, 메모리, 그래픽 처리 등을 소프트웨어로 모방합니다.
2. QEMU에서 CPU 에뮬레이션:
  QEMU는 다른 CPU 아키텍처를 에뮬레이트할 수 있습니다. 예를 들어, x86 기반의 컴퓨터에서 ARM 프로세서를 사용하는 모바일 애플리케이션을 테스트할 때, ARM 기반 시스템을 가지고 있지 않더라도 QEMU를 통해 ARM CPU의 동작을 에뮬레이션할 수 있습니다.
   이를 통해 x86 시스템에서 ARM 환경을 실행할 수 있게 되는 것입니다.
3. QEMU의 하드웨어 에뮬레이터 :
   다양한 하드웨어 아키텍처를 소프트웨어로 흉내 내는 기능을 제공합니다. 이를 통해, QEMU는 서로 다른 아키텍처에서 동작하는 운영체제나 소프트웨어를 실행할 수 있도록 도와줍니다. QEMU의 하드웨어 에뮬레이션은 특히 이종 아키텍처 간 호환성을 제공하는 데 중요한 역할

둘의 관계
1. KVM 단독 사용:
  KVM은 가상 머신의 CPU와 메모리를 가상화하여 네이티브 성능에 가까운 속도로 가상 머신을 실행합니다.
  하지만 KVM만으로는 네트워크 장치나 디스크 드라이브 같은 하드웨어 구성에 대한 유연성이 부족합니다.
2. QEMU 단독 사용:
   QEMU는 CPU, 메모리, 디스크, 네트워크 등을 모두 소프트웨어로 에뮬레이션할 수 있습니다. 그러나, CPU 성능이 낮아져 가상 머신이 느리게 실행됩니다.
3. QEMU + KVM 결합:
  QEMU는 디스크, 네트워크, USB 등 다양한 하드웨어 장치를 에뮬레이션하고, KVM은 호스트 CPU의 하드웨어 가속을 사용하여 성능을 크게 향상시킵니다.
  결과적으로, 가상 머신은 빠르게 실행되며, 다양한 하드웨어 장치를 사용할 수 있습니다.

그래서 이들의 관계를 그림으로 그리면 아래와 같다.
![image](https://github.com/user-attachments/assets/9560cdaa-e025-4760-a72d-68bfe0863775)

virt-manaeger와 qemu은 리눅스 커널 입장에서 그저 프로세스에 불과하다
아래와 같은 흐름을 가진다.
1. virt-manager가 새로운 가상 머신 기반 형태를 만든다.
2. virt-manager가 형태를 바탕으로 가상 머신을 생성해서 QEMU를 기동한다.
3. QEMU와 KVM이 연계해서 가상 머신을 필요한 만큼 실행한다.
4. virt-manager가 사용이 끝난 가상 머신을 삭제한다.

virt-manager는 가상 머신을 대상으로 다음과 같은 조작이 가능하다.
- 각 가상 머신에 준비된 창을 사용해서 가상 머신의 디스플레이 출력을 표시
- 키보드나 마우스를 사용해서 가상 머신의 키보드나 마우스를 조작
- 가상 머신의 전원 끄기, 켜기, 재시작을 처리
- 가상 머신의 장치 추가, 삭제 또는 iso 파일을 가상 DVD 드라이브에 넣고 꺼내기
  
![image](https://github.com/user-attachments/assets/bc8b93e7-a868-4f84-8305-2a40e7005ed4)

## 가상화는 지원하는 CPU 기능
CPU 기능
- 사용자 모드
- 커널 모드

하지만 가상화 기능을 지원하는 CPU의 기능
![image](https://github.com/user-attachments/assets/d9dfa321-149f-4370-8dec-19aa10ea5782)
- VMX-root 모드
  - 사용자 모드
  - 커널 모드
- VMX -nonroot 모드
  - 사용자 모드
  - 커널 모드

## 가상 머신은 호스트 OS에서 어떻게 보이는가?
## 가상화 환경과 프로세스 스케줄링
## 가상 머신과 메모리 관리
## 가상 머신과 저장 장치
