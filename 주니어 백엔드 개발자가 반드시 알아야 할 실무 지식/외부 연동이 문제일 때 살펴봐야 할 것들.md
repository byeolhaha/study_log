## 타임아웃
- 외부 연동에서 가장 중요한 설정 중 하나는 타임 아웃이다. 
- 연동 서비스를 호출할 때 타임아웃을 적절히 설정하지 않으면, 연동 서비스에 장애가 발생했을 때 전체 서비스의 품질이 급격히 나빠질 수 있다.
- 상황
  - A 서비스의 톰캣 스레드가 200개이다 즉 동시에 200개의 요청을 처리할 수 있다.
  - 그런데 어떤 한 기능에서 외부 서비스를 이용하는데 외부 서비스에 문제가 생겨서 응답 시간이 60초를 넘기기 시작했다.
  - 이 기능에 100개의 요청이 한번에 들어왔다.
  - 그리고 10초 뒤에 다시 100개의 요청이 들어왔다.
  - 그리고 다시 10초 뒤에 100개의 요청이 들어왔지만 이전에 들어온 요청들이 외부 서비스의 응답을 대기하고 있어서 스레드를 반환하지 않았고 이로 인해서 100개의 요청은 요청을 받지 못한 채 서비스가 마비되었다.
- 위 상황에서 세번째로 온 100개의 요청이 다른 기능이었다면 한 기능의 장애가 다른 기능에도 악영향을 주고 있는 것이다.
- 그리고 유저는 응답이 오지 않으면 새로 고침을 하게 되고 이로 인해 서버의 부하는 배가 된다.
- 이러한 문제를 완화할 수 있는 방법 중 하나가 타임 아웃을 지정하는 것이다.
- 타임 아웃을 지정하면 사용자는 화가 날 수 있지만 반응 없는 무한대기보다 나으며 자원이 포화되기 전에 응답을 할 수 있다. 따라서 스레드가 부족해져서 영향을 받을 수 있는 다른 기능에도 영향을 줄일 수 있다.

### 두 가지 타임아웃 : 연결 타임아웃, 읽기 타임아웃
<img width="2244" height="1532" alt="image" src="https://github.com/user-attachments/assets/f157ebb6-49ac-4ffb-ba45-70403d643333" />
- 연결 타임 아웃
  - 일단 빛보다 느림 그래서 네트워크 상황이나 연결할 서버의 상태에 따라 오래 걸릴 수 있다.
  - 이에 함께 대기 시간도 증가하므로 연결 타임 아웃을 설정해 연결 대기 시간을 제한해야 한다.
- 읽기 타임 아웃
  - 응답을 받기 까지의 대기 시간
  - 마찬가지로 응답 대기 시간이 길면 대기 시간이 길어진다.
- 처음 연동하는 서비스라면 타임 아웃 시간을 아래와 같이 설정한 뒤에 추이를 지켜보면서 조정한다.
  - 연결 타임 아웃 : 3초 ~ 5초
  - 읽기 타임 아웃 : 5초 ~ 30초
  - 내가 외부 서비스를 연동할 때 자주 사용하는 Spring Cloud의 OpenFeign의 기본값도 함께 살펴보자.
    아래와 같다. 이 설정은 기획팀과도 이야기가 되어져야 하며 읽기 타임 아웃 60초는 너무 길어서 좀 더 줄이고 비즈니스 팀과 적절한 값을 설정하고 모니터링을 하면서 조정하는 것이 좋을 거 같다.
    | 설정 항목            | 설명                                       | 기본값             |
    | ---------------- | ---------------------------------------- | --------------- |
    | `connectTimeout` | 서버와의 **TCP 연결을 맺는 데 걸리는 최대 시간**          | `10초 (10000ms)` |
    | `readTimeout`    | 연결 후 **서버 응답을 기다리는 시간** (즉, 응답 읽기 제한 시간) | `60초 (60000ms)` |
- 읽기 타임 아웃을 처음부터 1~3초로 너무 짧게 설정하면 성공임에도 불구하고 에러가 자주 발생한다.
  <img width="2524" height="1548" alt="image" src="https://github.com/user-attachments/assets/004ab695-3282-4259-a573-9b4000515f2f" />
  - 위 상황에서 고객은 카드로는 결제했지만 상품은 구매하지 못하는 상황이 만들어진다. 그래서 결제처럼 민감한 기능은 읽기 타임아웃 시간을 약간 길게 설정해서 간헐적으로 연동 시간이 길어지더라도 정상적으로 처리할 수 있어야 한다.
- 추가적으로, 이 읽기 타임 아웃을 지정할 때는 실제로 설정하는 값이 무엇인지 자세히 찾아보자. 왜냐하면
  Apache HttpClient에서는 이 읽기 타임 아웃이 소켓 타임 아웃으로 이용된다. 소켓 타임 아웃은 전체 응답 시간을 의미하는 것이 아니라 네트워크 패킷 단위 기준의 응답 시간이다.
  또한 OkHttp는 읽기 타임아웃과는 별개로 호출 타임 아웃을 설정할 수 있는데 이는 요청 시작부터 응답까지의 전체 시간 기준으로 설정된다.

    
## 재시도
- 외부 연동에 실패했을 때 처리 방법 중 하나는 재시도를 하는 것이다.
